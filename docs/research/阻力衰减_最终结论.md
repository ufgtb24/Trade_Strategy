# 阻力衰减研究：最终结论

> 研究日期：2024-12-14
> 研究方法：多视角头脑风暴 + 文档对比整合
> 参考文档：`docs/research/阻力衰减.md`

---

## 一、核心问题回顾

### 1.1 原始问题

```python
# 当前实现
recency_score = self._score_recency(broken_peaks, breakthrough.index)

# 问题：
# 1. decay_factors 衰减的是"分数本身"还是"阻力的有效性"？
# 2. 阻力的大小到底是什么？
# 3. recency_score 是否应该和 quality_score 整合？
```

### 1.2 语义错位

当前模型将 Recency 作为独立评分项与 Quantity/Density/Quality 平行相加：

$$R = w_1 \cdot Q + w_2 \cdot D + w_3 \cdot P + w_4 \cdot T$$

**物理类比的问题**：
- Quantity/Density/Quality 描述"这堵墙有多厚"
- Recency 描述"这堵墙风化了多少"
- **不能把"墙的厚度"和"风化程度"直接相加**

### 1.3 边界异常

| 场景 | 当前行为 | 问题 |
|------|----------|------|
| 无峰值时 | R = w4 × Recency > 0 | 没有峰值也有阻力？ |
| 极老峰值 | 其他项仍贡献高分 | 5年前的阻力位仍可得高分 |

---

## 二、阻力的本质

### 2.1 阻力的三重来源

| 来源 | 机制 | 衰减速度 | 可量化性 |
|------|------|----------|----------|
| **套牢盘（筹码）** | 解套心理驱动卖压 | 快（指数衰减） | 高 |
| **心理锚定** | 历史高点形成集体记忆 | 慢（双曲线衰减） | 低 |
| **成交共识** | 高成交量=价值共识区 | 中等 | 高 |

**关键洞察**：
- 阻力的本质是"有多少人仍在等待这个价位离场"，而非"过去有多少人买入"
- 成交量本身不直接产生阻力，而是**放大价格记忆的强度**

### 2.2 阻力的"相变"

```
时间演进
────────────────────────────────────────────────►

近期峰值          中期峰值           远期峰值
   │                 │                  │
   ▼                 ▼                  ▼
┌─────────┐    ┌─────────┐       ┌─────────┐
│ 交易阻力 │ →  │ 混合态  │   →   │心理地标 │
│(套牢盘)  │    │         │       │(历史意义)│
└─────────┘    └─────────┘       └─────────┘

   强阻力            中等              弱阻力
   弱意义          过渡态             强意义
```

**远期阻力不是"消失"，而是"相变"**：从"交易阻力"转化为"心理地标"。

### 2.3 衰减的双重机制

| 衰减对象 | 机制 | 衰减规律 |
|---------|------|---------|
| **筹码密度** | 换手率导致原成本区筹码减少 | 指数衰减 `e^(-换手率×天数)` |
| **心理锚定** | 记忆遗忘 + 注意力转移 | 双曲线衰减 `1/(1+αt)^β` |

---

## 三、数学模型对比

### 3.1 模型A：加法模型（当前实现）

$$R = w_1 Q + w_2 D + w_3 P + w_4 T$$

| 评价 | 说明 |
|------|------|
| ❌ 语义错误 | T 作为独立项意味着"时效性本身有价值" |
| ❌ 边界异常 | Q=D=P=0 时，R = w4×T > 0 |
| ❌ 衰减失效 | T→0 时，其他项仍保持原值 |

### 3.2 模型B：乘法模型

$$R = (w_1 Q + w_2 D + w_3 P) \times \tau$$

其中 $\tau = \text{avg}(e^{-\lambda t_i})$

| 评价 | 说明 |
|------|------|
| ✅ 语义正确 | 时间衰减作用于整体阻力 |
| ✅ 边界合理 | t→∞ 时 τ→0，故 R→0 |
| ⚠️ 过度衰减 | 历史最高价可能被过度削弱 |

### 3.3 模型C：质量加权衰减模型

$$R = \sum_{i=1}^{n} (q_i \cdot e^{-\lambda t_i}) + \beta \cdot D$$

| 评价 | 说明 |
|------|------|
| ✅ 物理精确 | 每个峰值独立衰减后累加 |
| ✅ 信息保留 | 保留峰值个体差异 |
| ⚠️ 计算复杂 | 需遍历每个峰值 |

### 3.4 模型D：混合模型（推荐）

$$R = R_{base} \cdot \tau_{adjusted} + H(t)$$

其中：
- $R_{base} = f(Q, D, P)$ 为基础阻力
- $\tau_{adjusted} = 0.3 + 0.7 \cdot e^{-\lambda t}$ 为带基线的衰减因子
- $H(t)$ 为历史意义加成（独立维度）

| 评价 | 说明 |
|------|------|
| ✅ 平衡机制 | 短期阻力衰减，长期保留历史意义 |
| ✅ 基线保护 | 30%基线避免过度衰减 |
| ✅ 符合系统 | 与当前双维度时间模型兼容 |

---

## 四、最终结论

### 4.1 需要修改的

| 修改项 | 原因 | 优先级 |
|--------|------|--------|
| **recency 从独立维度移入 quality** | 语义错误，应采用乘法模型 | P0 |
| **添加基线因子 `0.3 + 0.7×decay`** | 避免远期阻力过度衰减 | P0 |
| **重新分配权重** | 移除 recency 后重新平衡 | P0 |

### 4.2 不需要修改的

| 保留项 | 原因 |
|--------|------|
| **双维度时间模型架构** | 当前设计已正确分离"阻力衰减"和"历史意义" |
| **Peak 对象结构** | 保持纯数据对象，职责分离正确 |
| **衰减计算位置** | 在 Scorer 中计算是正确的架构选择 |
| **历史意义独立维度** | 正确捕捉了阻力的"相变"效应 |

### 4.3 可选优化（Phase 2）

| 优化项 | 说明 | 优先级 |
|--------|------|--------|
| **条件性历史加成** | 仅对高质量峰值（>70分）生效 | P2 |
| **密集度部分衰减** | `D × τ^α`（α < 1） | P3 |

---

## 五、推荐实现方案

### Phase 1：修正 recency 语义

**核心改变**：将 `effective_quality = quality × time_factor` 替代独立的 recency 维度

```python
def _get_resistance_breakdown(self, breakthrough) -> FeatureScoreDetail:
    """阻力强度评分（Phase 1 重构）"""
    broken_peaks = breakthrough.broken_peaks
    num_peaks = len(broken_peaks)

    if num_peaks == 0:
        return FeatureScoreDetail(score=0, ...)

    # 1. 结构因素（不衰减）
    quantity_score = self._score_quantity(num_peaks)
    density_score = self._score_density(broken_peaks)

    # 2. 质量因素（整合时间衰减）
    effective_qualities = []
    for peak in broken_peaks:
        age_bars = breakthrough.index - peak.index
        decay = self._calculate_time_decay_factor(age_bars)

        # 关键改变：quality × (baseline + decay)
        time_factor = 0.3 + 0.7 * decay  # 保留30%基线
        effective_q = peak.quality_score * time_factor
        effective_qualities.append(effective_q)

    avg_effective_quality = sum(effective_qualities) / num_peaks

    # 3. 新权重分配（移除 recency）
    # 原: quantity=0.25, density=0.25, quality=0.30, recency=0.20
    # 新: quantity=0.30, density=0.30, effective_quality=0.40
    resistance_score = (
        quantity_score * 0.30 +
        density_score * 0.30 +
        avg_effective_quality * 0.40
    )

    return FeatureScoreDetail(score=resistance_score, ...)
```

### Phase 2：条件性历史加成（可选）

```python
def _get_historical_breakdown(self, breakthrough) -> FeatureScoreDetail:
    """历史意义评分（Phase 2 增强）"""
    broken_peaks = breakthrough.broken_peaks

    # 条件性历史加成：仅计算高质量峰值（>70分）
    quality_threshold = 70
    significant_peaks = [p for p in broken_peaks if p.quality_score > quality_threshold]

    if not significant_peaks:
        significant_peaks = broken_peaks  # 降级处理

    # 后续计算逻辑保持不变...
```

---

## 六、配置文件更新

### 6.1 权重配置变更

```yaml
# configs/analysis/params/ui_params.yaml

quality_scorer:
  # 阻力强度权重（移除 recency）
  resistance_weights:
    quantity: 0.30      # 原 0.25
    density: 0.30       # 原 0.25
    quality: 0.40       # 原 0.30（现包含时间衰减）
    # recency: 已移除，整合到 quality 中

  # 时间衰减参数
  time_decay_half_life: 84        # 约4个月
  time_decay_baseline: 0.3        # 新增：基线因子（30%）

  # 历史意义权重（保持不变）
  historical_weights:
    oldest_age: 0.55
    suppression_span: 0.45
```

### 6.2 Schema 更新

需要更新 `param_editor_schema.py` 移除 `recency` 子参数，添加 `time_decay_baseline` 参数。

---

## 七、验证方法

### 7.1 回测验证

**假设**：高阻力分数的价格位，突破时需要更大的能量

**验证指标**：
```
Correlation(R_predicted, E_actual)

E_actual 可以是：
- 突破时的成交量放大倍数
- 突破前的整理时间
- 首次突破的回踩概率
```

### 7.2 A/B 对比

同时运行两个模型，比较预测准确率：
- 模型A：当前实现（加法模型）
- 模型B：改进实现（乘法模型）

---

## 八、核心认知总结

1. **阻力的本质是"价格记忆"** — 市场参与者对特定价位的集体记忆

2. **时间不是消灭阻力，而是转化阻力** — 从"交易阻力"转化为"心理地标"

3. **成交量是放大器，不是阻力本身** — 高成交量增强价格记忆的"刻度"

4. **时间衰减应作用于阻力系数** — 保持历史成交量作为客观事实，衰减的是其"当前影响力"

5. **recency 应与 quality 整合** — `effective_quality = peak_quality × time_factor`

6. **双重时间效应需要分离评估** — 阻力强度（衰减）和历史意义（增长）是两个独立维度

---

## 附录：相关代码位置

| 文件 | 位置 | 说明 |
|------|------|------|
| `quality_scorer.py` | L664-760 | `_get_resistance_breakdown()` |
| `quality_scorer.py` | L344-375 | `_score_recency()` （待移除）|
| `quality_scorer.py` | L325-342 | `_calculate_time_decay_factor()` |
| `quality_scorer.py` | L762-820 | `_get_historical_breakdown()` |
| `ui_params.yaml` | L29-33 | `resistance_weights` |
| `param_editor_schema.py` | L158-188 | `resistance_weights` schema |
