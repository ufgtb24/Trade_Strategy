# 峰值检测算法混合方案分析

> **分析日期**: 2025-12-23
> **分析对象**: 突破检测算法中的价格数据使用策略
> **当前系统架构**: 增量式 + Bonus 乘法评分模型

---

## 一、现有系统现状分析

### 1.1 当前的价格使用策略

**峰值检测阶段**（`breakout_detector.py: _detect_peak_in_window()`）：
- 使用 `high` 价格作为唯一峰值指标
- 相对高度计算：`(peak_high - window_min_low) / window_min_low >= min_relative_height`
- 严格高度检查：`(peak_high - window_min_high) / window_min_high >= min_strict_height`

**突破检测阶段**（`breakout_detector.py: _check_breakouts()`）：
- 使用 `current_high` 作为突破价格
- 双阈值设计：
  - 突破检测阈值：`exceed_threshold = 0.5%`（敏感）
  - 峰值移除阈值：`peak_supersede_threshold = 3%`（保守）

**特征计算阶段**（`features.py: _classify_type()`）：
- 突破类型分类：
  - `yang`: `close > open`（阳线）
  - `yin`: `close < open`（阴线）
  - `shadow`: `|close - open| / open < 1%`（上影线）

### 1.2 各价格数据的特征

| 价格类型 | 含义 | 优点 | 缺点 | 当前使用 |
|---------|------|------|------|--------|
| **high** | 日最高价 | 最强的上行压力；清晰的阻力位 | 易受突发跳空影响；缺乏确认 | ✅ 峰值检测、突破检测 |
| **close** | 收盘价 | 市场共识价格；反映参与者真实意愿 | 可能低于high；信息滞后 | ⚠️ 收益计算、类型分类 |
| **max(open, close)** | K线实体上界 | 剔除虚假上影线；代表真实推动力 | 可能错过上影线突破 | ❌ 未使用 |
| **(high+low+close)/3** | 典型价格 | 平衡高低；减少异常值影响 | 复杂度高；参数敏感 | ❌ 未使用 |

---

## 二、混合方案评估

### 方案1：加权平均（Weighted Price）

**公式**：
```
weighted_price = α·high + β·close + γ·max(open, close)
例如：weighted_price = 0.5·high + 0.3·close + 0.2·max(open, close)
```

**优点**：
- ✅ 综合多源数据，平衡突破强度与确认度
- ✅ 参数可调，灵活适应不同市场环境
- ✅ 平滑异常值影响

**缺点**：
- ❌ **参数敏感度高**：α+β+γ=1的约束，权重调整困难
- ❌ **解释性差**：无清晰的市场含义，难以回溯逻辑
- ❌ **参数优化成本高**：3个权重参数需联合优化
- ❌ **新增阈值复杂度**：原有exceed_threshold需调整以适配新价格

**实现复杂度**：⭐⭐ 中等
**参数调优难度**：⭐⭐⭐⭐ 高（权重耦合）
**与系统兼容性**：⭐⭐ 低（需改写突破检测逻辑）

**结论**：不推荐。权重耦合问题严重，参数调优成本超过收益。

---

### 方案2：条件选择（Conditional Selection）

**逻辑**：
```python
if 上影线过长（high - max(open, close) > 上影线阈值）:
    peak_price = max(open, close)  # 忽视虚假上影线
else:
    peak_price = high              # 正常使用最高价
```

**优点**：
- ✅ **逻辑清晰**：市场解释直观（"上影线陷阱"识别）
- ✅ **参数少**：只需1个上影线阈值（如 2-3%）
- ✅ **计算高效**：条件判断，O(1)复杂度
- ✅ **可解释性强**：易于回溯和调试

**缺点**：
- ⚠️ 二值决策，过于简化（间断性而非连续）
- ⚠️ 需要人工设定上影线阈值
- ⚠️ 某些情况下两者都合理，选择困难

**实现复杂度**：⭐ 简单
**参数调优难度**：⭐⭐ 低（仅1个阈值）
**与系统兼容性**：⭐⭐⭐⭐ 高（核心逻辑改动少）

**结论**：**推荐**。简洁优雅，成本低效果明确。

---

### 方案3：双重验证（Dual Validation）

**逻辑**：
```python
# 突破必须同时满足两个条件
if current_high > peak.price * (1 + exceed_threshold) AND
   current_close > peak.price * (1 + exceed_threshold):
    # 有效突破：high和close都确认
    mark_as_breakout()
```

**优点**：
- ✅ **过滤噪声**：高strong确认，假突破率低
- ✅ **逻辑严谨**：双重防线思路清晰
- ✅ **参数统一**：复用exceed_threshold

**缺点**：
- ❌ **过度严格**：合法突破被误过滤（上影线突破无法确认）
- ❌ **延迟识别**：等待close确认，实时性降低
- ❌ **与现有系统冲突**：突破检测现已同时检查high；变为冗余

**实现复杂度**：⭐ 简单
**参数调优难度**：⭐ 无新参数
**与系统兼容性**：⭐⭐ 低（不符合策略意图）

**结论**：不推荐。与"上影线突破"的策略意图冲突，反而降低灵敏度。

---

### 方案4：典型价格（Typical Price）

**公式**：
```
typical_price = (high + low + close) / 3
```

**优点**：
- ✅ 标准的技术分析指标
- ✅ 平衡高低市场参与者
- ✅ 减少极端值影响

**缺点**：
- ❌ **保守过度**：平均化削弱阻力位的突出性
- ❌ **参数增加**：需要新的相对高度阈值
- ❌ **金融逻辑薄弱**：为何要平均？在突破检测中无明确指导意义
- ❌ **低位偏差**：加入low，使峰值识别偏低

**实现复杂度**：⭐ 简单
**参数调优难度**：⭐⭐ 中等（需重新标定阈值）
**与系统兼容性**：⭐ 低（改变峰值识别逻辑）

**结论**：不推荐。在突破检测场景中无明确优势，反而弱化信号。

---

### 方案5：影线过滤（Shadow Filter）✅ **推荐**

**逻辑**：
```python
# 计算实体上界
entity_top = max(open, close)
shadow_ratio = (high - entity_top) / entity_top

if shadow_ratio > shadow_threshold:  # 例如 3%
    # 上影线过长：用实体上界替代high
    peak_price = entity_top
else:
    # 上影线正常：用high
    peak_price = high
```

**优点**：
- ✅ **市场解释合理**：K线实体代表真实推动力，影线为回试
- ✅ **自适应过滤**：连续阈值，而非二值
- ✅ **参数最少**：仅需 `shadow_threshold`（1个）
- ✅ **逻辑清晰**：易于理解和验证
- ✅ **扩展性好**：可应用于峰值检测和突破检测两处

**缺点**：
- ⚠️ 仍需设定影线阈值（2-3%建议值）
- ⚠️ 某些强势突破中，上影线也具有意义（需通过评分补偿）

**实现复杂度**：⭐ 简单（仅需2行条件判断）
**参数调优难度**：⭐⭐ 低（单一阈值，直观）
**与系统兼容性**：⭐⭐⭐⭐⭐ 最高（可逐步集成）
**可解释性**：⭐⭐⭐⭐⭐ 最强
**维护性**：⭐⭐⭐⭐⭐ 最佳

**结论**：**最强推荐**。最优的成本-收益比。

---

## 三、工程实践综合评比

| 维度 | 方案1加权 | 方案2条件选择 | 方案3双验证 | 方案4典型价 | 方案5影线过滤✅ |
|------|---------|----------|---------|---------|------------|
| **可解释性** | ⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **可维护性** | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **参数敏感度** | ⭐❌ | ⭐⭐ | ⭐ | ⭐⭐⭐ | ⭐⭐ |
| **系统兼容性** | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐ | ⭐⭐⭐⭐⭐ |
| **实现复杂度** | ⭐⭐ | ⭐ | ⭐ | ⭐ | ⭐ |
| **参数调优成本** | 高 | 低 | 无 | 中 | **低** |
| **策略收益** | 中等 | 中等 | 低 | 低 | **高** |
| **总体评分** | 4/10 | 7/10 | 5/10 | 4/10 | **9/10** |

---

## 四、推荐实现方案：影线过滤（Shadow Filter）

### 4.1 核心设计

**阶段1：峰值检测** 应用影线过滤
```python
def _get_peak_price(self, idx: int) -> float:
    """获取峰值判定价格（应用影线过滤）"""
    high = self.highs[idx]
    entity_top = max(self.opens[idx], self.closes[idx])

    shadow_ratio = (high - entity_top) / entity_top if entity_top > 0 else 0

    if shadow_ratio > self.shadow_threshold:  # 默认0.03
        # 上影线过长：使用实体上界
        return entity_top
    else:
        # 上影线正常：使用最高价
        return high
```

**阶段2：突破检测** 应用影线过滤
```python
def _check_breakouts(self, current_idx: int, ...):
    """检查突破（应用影线过滤）"""
    current_high = self.highs[current_idx]
    current_entity_top = max(self.opens[current_idx], self.closes[current_idx])

    # 选择适当的突破价格
    shadow_ratio = (current_high - current_entity_top) / current_entity_top
    breakout_price = (
        current_entity_top if shadow_ratio > self.shadow_threshold
        else current_high
    )

    for peak in self.active_peaks:
        if breakout_price > peak.price * (1 + self.exceed_threshold):
            # 突破...
```

### 4.2 参数配置

**新增参数**：
```yaml
# 影线过滤参数
shadow_threshold: 0.03  # 上影线相对实体上界的阈值（3%）
                        # 影线 > 3% 时，使用实体上界替代high

# 影响范围（可选）
apply_shadow_filter_to_peaks: true   # 峰值检测是否应用影线过滤
apply_shadow_filter_to_breakout: true # 突破检测是否应用影线过滤
```

**推荐的shadow_threshold值**：
- **2%**（激进）：敏感过滤，过滤大部分虚假上影线
- **3%**（平衡）：中等过滤，推荐为默认值
- **5%**（保守）：宽松过滤，仅过滤极端情况

### 4.3 实现步骤（渐进式）

#### 第1步：仅在突破检测中应用
```python
# 改动最小，风险最低
# 测试突破信号的改善情况
```

#### 第2步：扩展至峰值检测
```python
# 验证第1步效果后，应用于峰值识别
# 预期：更准确的阻力位定位
```

#### 第3步：反向兼容设置
```python
# 保留纯high模式的选项
# 支持A/B测试对比
```

### 4.4 预期效果

| 场景 | 改进 |
|------|------|
| **上影线陷阱** | 过滤虚假高点，避免高估阻力位 |
| **跳空突破** | 准确捕捉真实突破（不被上影线干扰） |
| **冲高回落** | 正确识别峰值，避免次峰值误判 |
| **缩量上涨** | 通过实体上界识别推动力，评分补偿 |

### 4.5 评分补偿机制

关键：**上影线长 ≠ 突破弱**，在评分中补偿

**Bonus模型中新增**（可选）：
```yaml
# 上影线质量Bonus
# 如果突破日上影线长（但high > peak），
# 且close/实体上界突破幅度大，可获得额外bonus
shadow_quality_bonus:
  high_shadow_with_strong_body: 1.15  # 长上影线但实体强势
```

**或在现有Bonus中调整**：
- Volume/Continuity Bonus权重提升
- 补偿过滤上影线带来的"保守性"

---

## 五、对比总结

### 推荐方案优势

✅ **影线过滤（方案5）** 是最优选择，理由：

1. **最小化改动**
   - 仅需新增1个参数 `shadow_threshold`
   - 核心逻辑改动 < 5行代码

2. **最强的可解释性**
   - K线实体 = 市场参与者共识
   - 上影线 = 回试压力，非必然突破信号

3. **最优的参数敏感度**
   - 单一阈值，敏感度明确可控
   - 2-5% 范围内鲁棒

4. **最高的系统兼容性**
   - 无需改写evaluate/scoring逻辑
   - 可逐步集成，支持A/B测试

5. **最佳的成本-收益比**
   - 实现成本：极低
   - 调优成本：极低
   - 预期收益：中高
   - **ROI = 高**

---

## 六、实施建议

### 短期（1-2周）

1. **方案验证**
   - 在突破检测中试点影线过滤
   - 对比突破精准度（false positive）
   - 收集4-6只测试股票的数据

2. **参数校正**
   - 确定最优的 `shadow_threshold`
   - 测试2% / 3% / 5%三档

### 中期（2-4周）

3. **扩展应用**
   - 应用到峰值检测（如效果确认）
   - 调整评分中的Bonus权重以补偿

4. **回测验证**
   - 历史回测评估整体策略效果
   - 对比原始方案的收益率、夏普比等

### 长期（持续优化）

5. **参数自适应**
   - 考虑根据市场波动率动态调整阈值
   - 但初期保持固定便于调试

---

## 七、不推荐原因汇总

| 方案 | 致命缺陷 |
|------|---------|
| **方案1：加权平均** | 权重耦合，参数优化困难；可解释性差 |
| **方案2：条件选择** | 虽然简单，但改动与影线过滤相同，逻辑不如方案5连续 |
| **方案3：双重验证** | 过度严格，与策略冲突，实际效果反而降低灵敏度 |
| **方案4：典型价格** | 保守过度，平均化削弱阻力信号，收益不明确 |

---

## 八、结论

### 推荐方案
**影线过滤（Shadow Filter）**
- 参数调优难度：⭐⭐ 低
- 系统兼容性：⭐⭐⭐⭐⭐ 最高
- 可解释性：⭐⭐⭐⭐⭐ 最强
- 实现复杂度：⭐ 极简
- **总体评分：9/10**

### 立即行动
1. 在 `breakout_detector.py` 中新增 `shadow_threshold` 参数
2. 在 `_check_breakouts()` 中应用影线过滤逻辑
3. 通过 4-6 只测试股票验证效果
4. 根据结果决定是否应用到峰值检测

### 预期收益
- ✅ 更准确的阻力位识别
- ✅ 更高的突破确认度
- ✅ 更强的参数稳定性
- ✅ 更易维护的代码逻辑

---

**文档维护者**：Claude Code
**最后更新**：2025-12-23
