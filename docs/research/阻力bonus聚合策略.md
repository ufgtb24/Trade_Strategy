# 阻力属性 Bonus 聚合策略研究

> 研究日期：2025-12-21
> 状态：研究完成，待决策

## 一、研究背景

### 1.1 问题描述

当一次突破穿越多个峰值时，阻力属性 Bonus（Age、Height、PeakVol、Tests）应该如何聚合？

**当前实现**（`quality_scorer.py:711-714`）：
```python
oldest_age = max(breakthrough.index - p.index for p in broken_peaks)
test_count = len(best_cluster)  # best_cluster = max(clusters, key=len)
max_height = max(p.relative_height for p in broken_peaks)
max_peak_volume = max(p.volume_surge_ratio for p in broken_peaks)
```

**核心问题**：
- Age/Height/PeakVol 取全局最大值
- Tests 取最大簇的大小
- 是否应该改为聚焦"价格最高的峰值/簇"？

### 1.2 示例场景

```
突破穿越 3 个峰值：
峰值A: 价格 100, age 200天, height 15%, volume 3x
峰值B: 价格 105, age 50天,  height 8%,  volume 2x  ← 价格最高
峰值C: 价格 98,  age 300天, height 25%, volume 8x  ← 各属性最大
```

| 策略 | Age | Height | PeakVol |
|------|-----|--------|---------|
| 当前：全局最大 | 300天 | 25% | 8x |
| 聚焦最高价 | 50天 | 8% | 2x |

---

## 二、技术分析原理

### 2.1 "最大值"策略的理论基础

**核心论点**：阻力由最强者决定

| 原理 | 解释 |
|------|------|
| 套牢盘心理 | 最久远的套牢者、最高位的套牢者、最重的筹码堆积——这些决定卖压强度 |
| 突破价值公式 | 突破价值 ∝ 被突破阻力的强度 |
| 破门效应 | 一扇门有多把锁，开门难度由最难的锁决定，而非平均值 |

**支持场景**：
```
场景：突破历史大顶 + 近期小回调

★ 峰值A (500天前, height 35%, volume 12x)  ← 历史大顶
★ 峰值B (30天前, height 5%, volume 2x)     ← 近期噪音

最大值策略：正确反映历史意义（Age=500天, Height=35%, Vol=12x）
平均值策略：被噪音稀释（Age=265天, Height=20%, Vol=7x）
```

### 2.2 "聚焦最高价"策略的理论基础

**核心论点**：最高价峰值是"最终关卡"

| 原理 | 解释 |
|------|------|
| 心理锚定 | 投资者对历史最高价记忆最深刻，形成最强心理阻力 |
| 套牢盘状态 | 低位套牢盘已解套并盈利，高位才是正在解套的有效阻力 |
| 技术分析共识 | 突破前高是强烈的多头信号，突破后空间打开 |

**支持场景**：
```
价格从 90 涨到 106 突破时：

峰值C (98, 8x放量)：已盈利 8%，不再是急于出逃的"解套盘"
峰值B (105, 2x放量)：刚刚解套，解套即卖的概率最高

结论：105 的 2x 放量才是"有效阻力"
```

---

## 三、分维度详细分析

### 3.1 Age Bonus（年龄/历史意义）

| 角度 | 分析 |
|------|------|
| **语义** | 阻力的"历史意义"——市场记忆的久远程度 |
| **全局最大的优势** | 一个 300 天前的老峰值即使在低位，突破它也有"打破长期格局"的意义 |
| **聚焦最高价的问题** | 最高价可能是近期形成的，丢失"突破老阻力"这一重要信号 |
| **与 Height 的关系** | Height 已评估价格位置，Age 应补充独立的时间维度 |

**结论**：**保持全局最大** ✅

**理由**：
1. Age 与 Height 形成互补（时间 vs 空间）
2. "打破 300 天震荡"比"突破 50 天前高点"更有意义
3. 符合文档共识："远期阻力 > 近期阻力"

---

### 3.2 Height Bonus（相对高度）

| 角度 | 分析 |
|------|------|
| **语义** | `relative_height` = 峰值相对局部窗口最低点的涨幅，反映"形态显著性" |
| **全局最大的优势** | 捕获 V 型反转顶部等强心理阻力形态（虽然价格低但形态显著） |
| **聚焦最高价的优势** | 投资者真正关注的是"最高点"的显著性 |
| **冗余风险** | 如果聚焦最高价，Height 变成"给最高价再加分"，与价格位置信息重叠 |

**两种观点**：

| 观点 | 推荐策略 | 理由 |
|------|----------|------|
| 保守派 | 保持全局最大 | V 型反转顶部虽价格低，但心理阻力确实强，值得加分 |
| 激进派 | 聚焦最高价 | 心理阻力应聚焦"最高点"的显著性，而非任意位置的形态 |

**结论**：**可选改为最高价峰值** ⚠️ （需权衡）

---

### 3.3 PeakVol Bonus（峰值放量）

| 角度 | 分析 |
|------|------|
| **语义** | 峰值形成时的放量倍数，反映"筹码堆积程度" |
| **关键洞察** | 筹码状态随价格变化——低位套牢盘可能已解套并转为盈利 |

**筹码状态分析**（价格=106 时）：

| 峰值 | 价格 | 放量 | 当前状态 | 行为预期 |
|------|------|------|----------|----------|
| C | 98 | 8x | 已盈利 8% | 不急于卖出，可能持有观望 |
| B | 105 | 2x | **刚刚解套** | **解套即卖的概率最高** |

**结论**：**建议改为最高价峰值** ⚠️

**理由**：
1. 低位的 8x 放量筹码已解套，不再是"急于出逃"的阻力
2. 高位的 2x 放量才是"正在解套"的有效阻力
3. PeakVol 应反映"当前有效阻力的筹码密度"，而非"历史最大筹码堆积"

---

### 3.4 Tests Bonus（测试次数）

| 角度 | 分析 |
|------|------|
| **语义** | "测试次数" = 同一阻力区被反复挑战的次数 |
| **当前实现** | 取最大簇（峰值数最多的簇） |
| **问题** | 低位簇可能峰值更多，但已被突破；高位簇才是"最终关卡" |

**场景分析**：

```
簇1 (97-100): 4 个峰值 ← 最大簇
簇2 (103-106): 2 个峰值 ← 价格最高

当前实现：test_count = 4（来自低位簇）
问题：低位簇的 4 次测试对"突破 106"有多大意义？
```

**结论**：**建议改为最高价簇** ⚠️

**理由**：
1. Tests 的真正含义是"最终阻力区被测试的次数"
2. 低位阻力区已被突破，其测试次数意义减弱
3. 最后的关卡才是决定突破成败的位置

---

## 四、风险分析

### 4.1 聚焦最高价的潜在风险

| 风险 | 说明 | 应对方案 |
|------|------|----------|
| **最高价是噪音峰值** | 短期假突破形成的低质量峰值可能成为最高价 | 质量过滤：若 `quality_score < 40`，回退到全局最大 |
| **丢失历史信息** | 远期主阻力可能在较低位置 | 保持 Age 用全局最大 |
| **评分维度重叠** | 所有 Bonus 都聚焦同一峰值，信息冗余 | 分维度采用不同策略 |

### 4.2 场景对比

**场景A：最高价是优质峰值**
```
峰值B (105): age 180天, height 20%, volume 5x ← 最高价且高质量

聚焦最高价：正确评估
全局最大：也能正确评估（如果 B 恰好是各维度最大）
```

**场景B：最高价是噪音峰值**
```
峰值A (95): age 200天, height 20%, volume 5x ← 真正的主阻力
峰值B (97): age 20天, height 3%, volume 0.8x ← 噪音（短期假突破）

聚焦最高价：错误评分（被噪音主导）
全局最大：正确评分（捕获主阻力的属性）
```

---

## 五、策略对比

### 5.1 三种策略总览

| 策略 | Age | Height | PeakVol | Tests | 特点 |
|------|-----|--------|---------|-------|------|
| **当前：全局最大** | 全局 | 全局 | 全局 | 最大簇 | 信息最大化，但低位属性可能无关 |
| **激进：全聚焦最高价** | 最高价 | 最高价 | 最高价 | 最高簇 | 聚焦最终关卡，但可能丢失历史信息 |
| **推荐：语义化分维度** | 全局 | 最高价 | 最高价 | 最高簇 | 各取所长，逻辑稍复杂 |

### 5.2 推荐方案：语义化分维度聚合

```python
def get_resistance_attributes(broken_peaks, clusters, breakthrough_index):
    """
    语义化分维度聚合策略

    - Age: 全局最老（历史意义与价格位置无关）
    - Height: 最高价峰值的高度（心理阻力聚焦最高点）
    - PeakVol: 最高价峰值的放量（有效阻力 = 正在解套的筹码）
    - Tests: 最高价簇的大小（最终关卡的测试次数）
    """
    # Age: 全局最老
    oldest_age = max(breakthrough_index - p.index for p in broken_peaks)

    # 找到价格最高的峰值
    highest_peak = max(broken_peaks, key=lambda p: p.price)

    # Height: 最高价峰值的高度
    max_height = highest_peak.relative_height

    # PeakVol: 最高价峰值的放量
    peak_volume = highest_peak.volume_surge_ratio

    # Tests: 最高价簇的大小
    highest_cluster = max(clusters, key=lambda c: max(p.price for p in c))
    test_count = len(highest_cluster)

    return oldest_age, max_height, peak_volume, test_count
```

### 5.3 各策略适用场景

| 场景 | 推荐策略 |
|------|----------|
| 突破历史大顶 + 近期噪音 | 全局最大（保留历史信息） |
| 多层阻力区逐级突破 | 语义化分维度（聚焦最终关卡） |
| 密集成交区突破 | 当前实现（最大簇反映密集度） |
| 单一强阻力位突破 | 任意策略（结果相同） |

---

## 六、结论与建议

### 6.1 核心结论

| Bonus | 当前实现 | 推荐方案 | 改动必要性 |
|-------|----------|----------|------------|
| **Age** | 全局最老 | **保持不变** | 不需要改动 |
| **Height** | 全局最大 | 可改为最高价峰值 | 可选优化 |
| **PeakVol** | 全局最大 | **建议改为最高价峰值** | 建议改动 |
| **Tests** | 最大簇 | **建议改为最高价簇** | 建议改动 |

### 6.2 决策建议

**保守方案**：保持当前实现不变
- 优点：经过验证，信息最大化
- 缺点：低位属性可能与"突破最终关卡"无关

**推荐方案**：采用语义化分维度聚合
- 优点：各维度采用语义最合适的方式
- 缺点：逻辑稍复杂，需要更新文档

### 6.3 后续行动

- [ ] 决定是否采用语义化方案
- [ ] 如采用，修改 `quality_scorer.py` 的聚合逻辑
- [ ] 更新 `02_技术分析模块_IMPL.md` 的相关说明
- [ ] 回测对比两种策略的评分差异

---

## 附录：代码修改示例

### A.1 当前实现

```python
# quality_scorer.py:708-714
oldest_age = max(breakthrough.index - p.index for p in broken_peaks)
test_count = len(best_cluster)  # best_cluster = max(clusters, key=len)
max_height = max(p.relative_height for p in broken_peaks)
max_peak_volume = max(p.volume_surge_ratio for p in broken_peaks)
```

### A.2 语义化方案

```python
# 语义化分维度聚合
# Age: 全局最老（历史意义）
oldest_age = max(breakthrough.index - p.index for p in broken_peaks)

# 找到价格最高的峰值和簇
highest_peak = max(broken_peaks, key=lambda p: p.price)
highest_cluster = max(clusters, key=lambda c: max(p.price for p in c))

# Height: 最高价峰值（心理阻力聚焦最高点）
max_height = highest_peak.relative_height

# PeakVol: 最高价峰值（有效阻力 = 正在解套的筹码）
max_peak_volume = highest_peak.volume_surge_ratio

# Tests: 最高价簇（最终关卡的测试次数）
test_count = len(highest_cluster)
```

---

**文档维护者**：Claude Code
**最后更新**：2025-12-21
