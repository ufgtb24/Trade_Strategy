# 突破选股策略系统开发计划

## 文档说明

### 开发方式选择

本项目采用**两步开发法**：

1. **第一步**：基于本计划文档，为每个核心模块编写详细的技术设计文档
2. **第二步**：基于技术设计文档进行代码实现

**选择理由**：
- 本系统是复杂的量化交易系统，涉及多个子系统协同工作
- 凸点识别、突破检测等核心算法需要详细的算法设计和伪代码
- 实盘交易涉及资金安全，必须经过仔细的架构设计和评审
- 详细的技术文档有助于模块化开发、单元测试和后续维护
- 便于在编码前发现设计缺陷，降低返工成本

### 计划文档用途

本文档定义：
- 系统的模块化架构
- 各模块的职责边界
- 模块间的依赖关系和接口
- 开发阶段划分和优先级
- 与现有代码库的复用关系

本文档**不包含**实现细节（如算法伪代码、数据结构、具体接口定义等），这些内容将在各模块的技术设计文档中详细说明。

---

## 一、项目概述

### 1.1 项目目标

开发一套完整的突破选股策略系统，用于美股市场的量化交易，实现：
- 自动识别历史阻力位（凸点）和突破走势
- 多阶段筛选和质量评估
- 双观察池监测机制（实时+日K）
- 实盘自动交易和风险管理
- 策略回测和参数优化

### 1.2 核心策略机制

**策略流程**：搜索 → 监测 → 交易 → 持仓管理

**核心概念**：
- **凸点**：股价高于两侧一定时段的高点，形成历史阻力位
- **突破点**：股价高于凸点最高价，确认突破
- **双观察池**：
  - 实时观察池：监测当日突破，防止直接起飞
  - 日K观察池：监测突破后回落，等待企稳走强
- **循环跟踪**：止盈止损后重新加入观察池，捕捉多轮波动

### 1.3 技术栈

- **编程语言**：Python 3.8+
- **数据源**：Tiger Open API（美股实时/历史行情）
- **交易接口**：Tiger Open API（下单、撤单、查询）
- **回测框架**：Backtrader（可选）或自研回测引擎
- **参数优化**：Optuna
- **数据存储**：SQLite / PostgreSQL
- **核心库**：pandas, numpy, scipy, matplotlib, pyyaml

---

## 二、与现有代码库的关系

### 2.1 现有架构评估

当前项目（new_trade）已实现**两阶段选股机制**：
- **第一阶段（ScreenerDayFeature）**：基于技术过滤器快速筛选特定交易日
- **第二阶段（ScreenerBackTrader）**：使用backtrader指标深度验证

### 2.2 复用与扩展策略

| 模块 | 复用程度 | 说明 |
|------|---------|------|
| **数据下载框架** | 部分复用 | 复用DataProcess的多进程下载框架和预处理机制，扩展支持Tiger API |
| **配置管理** | 复用思路 | 借鉴YAML配置文件模式和参数持久化机制 |
| **两阶段筛选思想** | 借鉴思路 | 复用"快速筛选→深度分析"的设计理念，但核心算法需重写 |
| **可视化框架** | 部分复用 | 借鉴UI基础框架和backtrader图表生成 |
| **核心筛选算法** | 不复用 | 现有filters针对不同策略设计，突破策略需要全新的凸点识别和突破检测算法 |
| **观察池系统** | 不复用 | 全新功能，现有代码库不包含 |
| **实盘交易** | 不复用 | 全新功能，现有代码库仅支持回测 |
| **实时监测** | 不复用 | 全新功能，需要WebSocket实时行情订阅 |

### 2.3 目录结构设计

建议新建独立目录 `BreakoutStrategy/`，与现有 `ScreenerDayFeature/` 和 `ScreenerBackTrader/` 平行：

```
new_trade/
├── DataProcess/              # 现有：数据下载（可扩展支持Tiger API）
├── ScreenerDayFeature/       # 现有：第一阶段选股
├── ScreenerBackTrader/       # 现有：第二阶段选股
├── BreakoutStrategy/     # 新增：突破选股策略系统
│   ├── data/                 # 数据层
│   ├── analysis/             # 技术分析模块
│   ├── search/               # 搜索系统
│   ├── observation/          # 观察池系统
│   ├── monitoring/           # 监测系统
│   ├── trading/              # 交易执行
│   ├── risk/                 # 风险管理
│   ├── backtest/             # 回测系统
│   ├── config/               # 配置管理
│   └── utils/                # 工具与辅助
├── UI/                       # 现有：可视化界面（可扩展）
├── datasets/                 # 现有：数据存储（可扩展）
├── ext_file/                 # 现有：输出文件（可扩展）
└── docs/                     # 文档
    ├── breakout_strategy.md  # 现有：策略文档
    └── 开发计划.md                # 本文档
```

---

## 三、系统模块化设计

### 3.1 模块总览

本系统划分为10个核心模块，按功能分层：

| 层级 | 模块 | 职责 |
|------|------|------|
| **基础层** | 数据层（data） | Tiger API数据获取、缓存、实时订阅 |
| **基础层** | 配置管理（config） | 参数配置、验证、持久化 |
| **基础层** | 工具与辅助（utils） | 日志、数据库、可视化、日期工具 |
| **分析层** | 技术分析（analysis） | 凸点识别、突破检测、质量评分 |
| **应用层** | 搜索系统（search） | 历史突破搜索、股票过滤 |
| **应用层** | 观察池（observation） | 双观察池管理、池间转换 |
| **应用层** | 监测系统（monitoring） | 实时监控、信号检测、警报 |
| **应用层** | 交易执行（trading） | Tiger API交易、订单管理、持仓追踪 |
| **应用层** | 风险管理（risk） | 止盈止损、仓位管理 |
| **验证层** | 回测系统（backtest） | 策略回测、性能分析、参数优化 |

### 3.2 模块依赖关系图

```
┌─────────────────────────────────────────────────────────┐
│                    配置管理 (config)                     │ ← 全局依赖
│                  工具与辅助 (utils)                      │
└─────────────────────────────────────────────────────────┘
                            ↑
┌───────────────────────────┼───────────────────────────┐
│                      数据层 (data)                      │
│  - TigerDataAdapter                                    │
│  - DataCache                                           │
│  - RealtimeStream                                      │
└───────────────────────────┬───────────────────────────┘
                            ↓
┌───────────────────────────┼───────────────────────────┐
│                  技术分析模块 (analysis)                 │
│  - PeakDetector (凸点识别)                             │
│  - BreakoutDetector (突破检测)                         │
│  - QualityScorer (质量评分)                            │
└───────────────────────────┬───────────────────────────┘
                            ↓
         ┌──────────────────┴──────────────────┐
         ↓                                     ↓
┌────────────────────┐              ┌────────────────────┐
│  搜索系统 (search)   │              │ 观察池 (observation)│
│  - HistoricalScanner│──────────→  │  - RealtimePool    │
│  - StockFilter      │              │  - DailyPool       │
│  - SearchEngine     │              │  - PoolManager     │
└────────────────────┘              └─────────┬──────────┘
                                              ↓
                                    ┌────────────────────┐
                                    │ 监测系统 (monitoring)│
                                    │  - RealtimeMonitor │
                                    │  - SignalDetector  │
                                    └─────────┬──────────┘
                                              ↓
                                    ┌────────────────────┐
                                    │ 交易执行 (trading)  │
                                    │  - TigerTradeAPI   │
                                    │  - OrderManager    │
                                    │  - PositionTracker │
                                    └─────────┬──────────┘
                                              ↓
                                    ┌────────────────────┐
                                    │ 风险管理 (risk)     │
                                    │  - StopLossManager │
                                    │  - TakeProfitMgr   │
                                    └────────────────────┘
         ┌──────────────────────────────────┘
         ↓
┌────────────────────┐
│  回测系统 (backtest)│
│  - BacktestEngine  │
│  - ParamOptimizer  │
└────────────────────┘
```

---

## 四、核心模块详细设计

### 4.1 数据层（BreakoutStrategy/data/）

**职责**：
- 与Tiger Open API交互，获取美股历史和实时行情数据
- 本地数据缓存管理（避免重复请求）
- 实时行情WebSocket订阅
- 数据质量验证和清洗

**子模块**：

| 子模块 | 职责 | 输入 | 输出 |
|--------|------|------|------|
| **TigerDataAdapter** | Tiger API封装，提供统一的数据接口 | 股票代码、时间范围、数据类型 | DataFrame格式的行情数据 |
| **DataCache** | 历史数据缓存管理（SQLite/PostgreSQL） | 数据请求 | 缓存数据或触发下载 |
| **RealtimeStream** | WebSocket实时行情订阅 | 股票代码列表 | 实时价格/成交量推送 |
| **DataValidator** | 数据质量验证（缺失值、异常值） | 原始数据 | 验证报告和清洗后的数据 |

**接口定义示例**（详细接口定义见技术设计文档）：
- `get_historical_data(symbol, start_date, end_date, freq='1d')` → DataFrame
- `get_realtime_quote(symbol)` → dict
- `subscribe_realtime(symbols, callback)` → None
- `cache_data(symbol, data)` → None

**依赖**：
- 外部：Tiger Open API SDK (`tigeropen`)
- 内部：config（API配置）、utils（日志、数据库）

**输出物**：
- 技术设计文档：`docs/modules/01_数据层设计.md`

---

### 4.2 技术分析模块（BreakoutStrategy/analysis/）

**职责**：
- 实现凸点识别算法（核心算法）
- 实现突破检测算法（核心算法）
- 实现质量评分系统（凸点质量、突破质量）
- 提供常用技术指标计算（成交量、RSI、MA等）

**子模块**：

| 子模块 | 职责 | 核心算法 |
|--------|------|---------|
| **PeakDetector** | 凸点识别 | - 局部最高点检测<br>- 特殊意义点识别<br>- 凸点合并（同价位多凸点） |
| **BreakoutDetector** | 突破检测 | - 突破确认判断<br>- 突破类型识别（阳线/阴线/上影线） |
| **QualityScorer** | 质量评分 | - 凸点质量评分（放量、长K线、压制时间等）<br>- 突破质量评分（涨幅、跳空、放量、连续性） |
| **TechnicalIndicators** | 技术指标 | - 成交量指标（相对成交量、放量倍数）<br>- 价格指标（涨跌幅、K线类型）<br>- 趋势指标（MA、RSI） |

**核心算法设计要点**（详细算法见技术设计文档）：

1. **凸点识别算法**：
   - 输入：价格序列、参数（lookback_bars, lookforward_bars, merge_threshold）
   - 输出：凸点列表（位置、价格、类型、质量分数）
   - 考虑因素：普通凸点、特殊意义点、凸点合并

2. **突破检测算法**：
   - 输入：价格序列、凸点列表、突破确认参数
   - 输出：突破点列表（位置、对应凸点、突破类型、质量分数）
   - 考虑因素：突破确认标准、突破类型、假突破过滤

3. **质量评分系统**：
   - 凸点质量因素：放量、长K线、压制时间、同价多凸点、相对高度
   - 突破质量因素：涨幅、跳空、放量、连续性、稳定性
   - 评分方法：加权评分或机器学习模型

**依赖**：
- 内部：data（数据获取）、config（参数配置）

**输出物**：
- 技术设计文档：`docs/modules/02_技术分析模块设计.md`

---

### 4.3 搜索系统（BreakoutStrategy/search/）

**职责**：
- 扫描美股市场，找到已完成突破的股票
- 应用基础过滤器（市值、流动性、价格）
- 对搜索结果进行质量评估和排序
- 输出候选股票列表供观察池使用

**子模块**：

| 子模块 | 职责 | 输入 | 输出 |
|--------|------|------|------|
| **HistoricalScanner** | 扫描历史突破 | 股票池、时间范围（如过去7天） | 候选突破列表 |
| **StockFilter** | 股票过滤器 | 股票列表、过滤条件 | 过滤后的股票列表 |
| **SearchEngine** | 搜索引擎主控 | 搜索参数配置 | 完整的搜索结果 |
| **ResultFormatter** | 结果格式化 | 搜索结果 | 格式化输出（文件/数据库） |

**工作流程**：
1. 获取股票池（从Tiger API或本地缓存）
2. 应用基础过滤器（市值、流动性、价格范围）
3. 对每只股票：
   - 下载历史数据
   - 调用PeakDetector识别凸点
   - 调用BreakoutDetector检测突破
   - 调用QualityScorer评估质量
4. 汇总结果，按质量分数排序
5. 输出结果到文件或数据库

**输出格式**（详细格式见技术设计文档）：
```
symbol,breakout_date,peak_date,peak_price,breakout_price,peak_quality,breakout_quality,combined_score
AAPL,2024-01-15,2023-12-20,195.50,196.20,85.5,78.3,82.1
TSLA,2024-01-14,2023-11-10,245.00,248.50,92.3,88.7,90.6
```

**依赖**：
- 内部：data、analysis、config

**输出物**：
- 技术设计文档：`docs/modules/03_搜索系统设计.md`

---

### 4.4 观察池系统（BreakoutStrategy/observation/）

**职责**：
- 管理双观察池（实时观察池、日K观察池）
- 实现池间转换逻辑
- 持久化存储观察池状态
- 提供观察池查询和统计接口

**子模块**：

| 子模块 | 职责 | 管理内容 |
|--------|------|---------|
| **RealtimePool** | 实时观察池管理 | - 当日突破的股票<br>- 观察期限：REALTIME_OBSERVATION_DAYS（默认1天）<br>- 退出条件：触发买入、超时 |
| **DailyPool** | 日K观察池管理 | - 突破后回落的股票<br>- 观察期限：DAILY_OBSERVATION_DAYS（默认30天）<br>- 退出条件：触发买入、观察期满 |
| **PoolManager** | 观察池管理器 | - 池间转换逻辑<br>- 加入/移除股票<br>- 循环跟踪（止盈止损后重新加入） |
| **PoolStorage** | 持久化存储 | - 观察池状态保存到数据库<br>- 崩溃恢复 |

**数据结构**（详细设计见技术设计文档）：

```python
# 观察池条目
ObservationEntry = {
    'symbol': str,               # 股票代码
    'add_date': datetime,        # 加入日期
    'breakout_date': datetime, # 突破日期
    'peak_info': dict,           # 凸点信息
    'breakout_info': dict,   # 突破信息
    'quality_scores': dict,      # 质量分数
    'status': str,               # 'active', 'bought', 'timeout', 'expired'
    'retry_count': int,          # 重试次数（循环跟踪）
}
```

**池间转换规则**：
- 搜索系统 → 实时池：当日突破的股票
- 搜索系统 → 日K池：过去N天突破的股票
- 实时池 → 日K池：观察超时但未触发买入
- 日K池 → 交易系统：触发买入信号
- 交易系统 → 日K池：止盈止损后（循环跟踪）

**依赖**：
- 内部：data、analysis、config、utils（数据库）

**输出物**：
- 技术设计文档：`docs/modules/04_观察池系统设计.md`

---

### 4.5 监测系统（BreakoutStrategy/monitoring/）

**职责**：
- 实时监控观察池中的股票行情
- 检测买入信号（实时买入、日K买入）
- 触发警报通知
- 调度监控任务

**子模块**：

| 子模块 | 职责 | 监控对象 |
|--------|------|---------|
| **RealtimeMonitor** | 实时行情监控 | - 实时观察池中的股票<br>- 使用WebSocket推送<br>- 分钟级别监控 |
| **SignalDetector** | 买入信号检测 | - 实时买入信号：价格超过突破日K线实体上沿X%<br>- 日K买入信号：企稳走强信号 |
| **AlertManager** | 警报系统 | - 发送买入信号通知<br>- 异常警报（如API断线） |
| **MonitorScheduler** | 监控调度器 | - 调度实时监控任务<br>- 调度日K观察池更新任务 |

**买入信号逻辑**（详细逻辑见技术设计文档）：

1. **实时买入信号**（适用于实时观察池）：
   - 条件：当前价格 > 突破日K线实体上沿 × (1 + REALTIME_BUY_THRESHOLD_PCT)
   - 执行：立即下单（或发送警报）

2. **日K买入信号**（适用于日K观察池）：
   - 条件：企稳走强信号（如阳线突破、放量上涨、RSI回升等）
   - 执行：次日开盘或盘中买入

**监控流程**：
```
启动监控 → 订阅实时行情 → 接收价格推送 → 检测买入信号
                ↓                               ↓
         更新观察池状态                    触发警报/下单
```

**依赖**：
- 内部：data（实时数据）、observation（观察池）、analysis（信号检测）、config

**输出物**：
- 技术设计文档：`docs/modules/05_监测系统设计.md`

---

### 4.6 交易执行（BreakoutStrategy/trading/）

**职责**：
- 与Tiger Open API交互，执行买卖操作
- 订单管理（创建、撤单、查询）
- 持仓追踪和管理
- 交易日志记录

**子模块**：

| 子模块 | 职责 | 功能 |
|--------|------|------|
| **TigerTradeAPI** | Tiger API交易接口封装 | - 下单（市价单、限价单）<br>- 撤单<br>- 查询订单状态<br>- 查询持仓 |
| **OrderManager** | 订单管理 | - 订单生命周期管理<br>- 订单状态同步<br>- 订单历史记录 |
| **PositionTracker** | 持仓追踪 | - 实时持仓监控<br>- 持仓盈亏计算<br>- 持仓信息持久化 |
| **ExecutionEngine** | 交易执行引擎 | - 执行买入/卖出逻辑<br>- 重试机制<br>- 交易异常处理 |

**订单类型支持**：
- 市价单（Market Order）：快速成交
- 限价单（Limit Order）：控制价格
- 止损单（Stop Order）：风险控制

**交易流程**（详细流程见技术设计文档）：
```
监测系统检测到买入信号 → ExecutionEngine创建订单 → OrderManager提交订单
    → TigerTradeAPI下单 → 监控订单状态 → 订单成交 → PositionTracker更新持仓
```

**依赖**：
- 外部：Tiger Open API SDK
- 内部：data、config、utils（日志、数据库）

**输出物**：
- 技术设计文档：`docs/modules/06_交易执行设计.md`

---

### 4.7 风险管理（BreakoutStrategy/risk/）

**职责**：
- 实施止损策略
- 实施止盈策略
- 仓位管理
- 风险控制和合规检查

**子模块**：

| 子模块 | 职责 | 策略类型 |
|--------|------|---------|
| **StopLossManager** | 止损管理 | - 固定止损<br>- 移动止损<br>- 时间止损 |
| **TakeProfitManager** | 止盈管理 | - 跟踪止盈<br>- 目标止盈<br>- 分批止盈 |
| **PositionSizer** | 仓位管理 | - 单只股票最大仓位<br>- 总持仓控制<br>- 动态仓位调整 |
| **RiskController** | 风险控制器 | - 最大回撤控制<br>- 日内交易次数限制<br>- 资金使用率监控 |

**止盈止损策略**（详细策略见技术设计文档）：

1. **固定止损**：
   - 买入价 × (1 - STOP_LOSS_PCT)

2. **移动止损**：
   - 最高价 × (1 - TRAILING_STOP_PCT)

3. **跟踪止盈**：
   - 达到目标收益后，使用移动止盈

4. **目标止盈**：
   - 买入价 × (1 + TARGET_PROFIT_PCT)

**仓位管理规则**：
- 单只股票最大仓位：`MAX_POSITION_SIZE_PCT`（如10%）
- 最大持仓数量：`MAX_HOLDINGS`（如10只）
- 总资金使用率：`MAX_CAPITAL_USAGE_PCT`（如80%）

**循环跟踪逻辑**：
- 止盈止损后，将股票重新加入日K观察池
- 作为"加强观察目标"，提高关注度
- 累积之前的突破信息作为正向特征

**依赖**：
- 内部：trading（持仓信息）、observation（循环跟踪）、config

**输出物**：
- 技术设计文档：`docs/modules/07_风险管理设计.md`

---

### 4.8 回测系统（BreakoutStrategy/backtest/）

**职责**：
- 使用历史数据验证策略有效性
- 计算性能指标（收益率、夏普比率、最大回撤等）
- 参数优化（基于Optuna）
- 生成回测报告

**子模块**：

| 子模块 | 职责 | 功能 |
|--------|------|------|
| **BacktestEngine** | 回测引擎 | - 模拟历史交易<br>- 事件驱动回测<br>- 支持滑点和手续费 |
| **PerformanceAnalyzer** | 性能分析器 | - 收益率计算<br>- 风险指标（夏普比率、最大回撤）<br>- 交易统计（胜率、盈亏比） |
| **ParameterOptimizer** | 参数优化器 | - 基于Optuna的参数优化<br>- 多目标优化<br>- 交叉验证 |
| **BacktestReporter** | 回测报告生成 | - 生成HTML/PDF报告<br>- 可视化收益曲线<br>- 交易明细导出 |

**回测框架选择**：
- **方案一**：基于Backtrader（复用现有框架）
- **方案二**：自研回测引擎（更灵活，但开发量大）
- **推荐**：方案一（快速验证），后期可扩展为方案二

**性能指标**（详细计算方法见技术设计文档）：
- 总收益率、年化收益率
- 夏普比率、索提诺比率
- 最大回撤、最大回撤持续时间
- 胜率、盈亏比
- 交易次数、平均持仓时间

**参数优化流程**：
```
定义参数空间 → Optuna采样参数 → 运行回测 → 计算目标函数
    → 更新参数分布 → 重复N次 → 输出最优参数
```

**依赖**：
- 内部：data、analysis、search、observation、monitoring、trading、risk、config

**输出物**：
- 技术设计文档：`docs/modules/08_回测系统设计.md`

---

### 4.9 配置管理（BreakoutStrategy/config/）

**职责**：
- 管理所有参数配置
- 提供配置验证
- 支持多环境配置（开发、测试、生产）
- 配置文件格式：YAML

**子模块**：

| 子模块 | 职责 |
|--------|------|
| **ConfigManager** | 配置管理器（加载、保存、查询配置） |
| **ParameterValidator** | 参数验证器（验证参数合法性） |
| **DefaultConfigs** | 默认配置（提供默认参数值） |

**配置文件结构**（详细配置见技术设计文档）：

```yaml
# config/default.yaml

# 时间参数
time:
  historical_search_days: 7
  realtime_observation_days: 1
  daily_observation_days: 30
  peak_lookback_bars: 20
  peak_lookforward_bars: 10

# 价格参数
price:
  realtime_buy_threshold_pct: 0.02  # 2%
  breakout_min_exceed_pct: 0.005    # 0.5%

# 风险管理参数
risk:
  stop_loss_pct: 0.05               # 5%
  trailing_stop_pct: 0.03           # 3%
  target_profit_pct: 0.15           # 15%
  max_position_size_pct: 0.10       # 10%
  max_holdings: 10

# 质量评估参数
quality:
  volume_surge_multiplier: 2.0
  long_candle_threshold_pct: 0.05   # 5%
  peak_quality_min_score: 60
  breakout_quality_min_score: 70
  peak_supersede_threshold_pct: 0.03    # 3%

# 搜索参数
search:
  market_cap_min: 1000000000        # 10亿美元
  avg_volume_min: 1000000           # 100万
  price_min: 5.0                    # 5美元

# API配置
api:
  tiger_api_rate_limit: 10          # 请求/秒
  data_fetch_retry_count: 3
  websocket_reconnect_interval: 60  # 秒
  market_data_cache_duration: 60    # 分钟
```

**依赖**：
- 外部：pyyaml
- 内部：utils（日志）

**输出物**：
- 技术设计文档：`docs/modules/09_配置管理设计.md`

---

### 4.10 工具与辅助（BreakoutStrategy/utils/）

**职责**：
- 提供日志系统
- 提供数据库管理工具
- 提供可视化工具
- 提供日期时间工具

**子模块**：

| 子模块 | 职责 | 功能 |
|--------|------|------|
| **Logger** | 日志系统 | - 多级别日志（DEBUG, INFO, WARNING, ERROR）<br>- 文件日志和控制台日志<br>- 日志轮转 |
| **DatabaseManager** | 数据库管理 | - SQLite/PostgreSQL封装<br>- 连接池管理<br>- 事务管理 |
| **Visualizer** | 可视化工具 | - K线图绘制<br>- 凸点和突破点标注<br>- 收益曲线绘制 |
| **DateUtils** | 日期工具 | - 交易日判断<br>- 日期范围生成<br>- 时区转换 |

**数据库表设计**（详细设计见技术设计文档）：

主要表：
- `historical_data`：历史行情数据缓存
- `peaks`：凸点信息
- `breakouts`：突破信息
- `observation_pool_realtime`：实时观察池
- `observation_pool_daily`：日K观察池
- `orders`：订单记录
- `positions`：持仓记录
- `trades`：成交记录

**依赖**：
- 外部：matplotlib, sqlite3/psycopg2

**输出物**：
- 技术设计文档：`docs/modules/10_工具与辅助设计.md`

---

## 五、开发阶段规划

### 5.1 阶段划分

本项目分为5个开发阶段，采用**迭代式开发**，每个阶段交付可运行的子系统。

| 阶段 | 时间估算 | 核心目标 | 可交付成果 |
|------|---------|---------|-----------|
| **阶段一** | 4-6周 | 核心基础 | 数据层、技术分析模块、配置管理可运行 |
| **阶段二** | 3-4周 | 搜索与回测 | 历史突破搜索、策略回测可运行 |
| **阶段三** | 3-4周 | 观察池与监测 | 双观察池、实时监测可运行 |
| **阶段四** | 3-4周 | 交易执行与风险管理 | 实盘交易、风险控制可运行 |
| **阶段五** | 2-3周 | 优化与部署 | 参数优化、生产部署完成 |

**总时长估算**：15-21周（约4-5个月）

---

### 5.2 阶段一：核心基础（4-6周）

**目标**：建立系统的核心基础设施，实现凸点识别和突破检测算法。

**主要任务**：

1. **第1周：技术设计文档编写**
   - 编写数据层技术设计文档
   - 编写技术分析模块技术设计文档
   - 编写配置管理和工具模块技术设计文档
   - 评审技术设计文档

2. **第2-3周：数据层开发**
   - 实现TigerDataAdapter（Tiger API封装）
   - 实现DataCache（本地缓存）
   - 实现DataValidator（数据验证）
   - 单元测试
   - 申请Tiger API账号和权限

3. **第4-5周：技术分析模块开发**
   - 实现PeakDetector（凸点识别算法）
   - 实现BreakoutDetector（突破检测算法）
   - 实现QualityScorer（质量评分系统）
   - 实现TechnicalIndicators（技术指标）
   - 单元测试和算法验证

4. **第6周：配置管理和工具开发**
   - 实现ConfigManager
   - 实现Logger
   - 实现DatabaseManager
   - 实现Visualizer（基础可视化）
   - 集成测试

**验收标准**：
- 能够从Tiger API下载历史数据并缓存
- 能够识别历史数据中的凸点和突破点
- 能够对凸点和突破点进行质量评分
- 能够可视化凸点和突破点

**产出物**：
- 技术设计文档3份
- 代码模块：data/, analysis/, config/, utils/
- 单元测试代码
- 集成测试报告

---

### 5.3 阶段二：搜索与回测（3-4周）

**目标**：实现历史突破搜索系统，并通过回测验证策略有效性。

**主要任务**：

1. **第1周：技术设计文档编写**
   - 编写搜索系统技术设计文档
   - 编写回测系统技术设计文档
   - 评审技术设计文档

2. **第2周：搜索系统开发**
   - 实现HistoricalScanner
   - 实现StockFilter
   - 实现SearchEngine
   - 实现ResultFormatter
   - 单元测试

3. **第3周：回测系统开发**
   - 实现BacktestEngine（基于Backtrader或自研）
   - 实现PerformanceAnalyzer
   - 实现BacktestReporter
   - 单元测试

4. **第4周：策略验证和优化**
   - 使用历史数据进行回测
   - 分析回测结果
   - 调整算法参数
   - 优化凸点识别和突破检测算法

**验收标准**：
- 能够扫描美股市场，找到历史突破的股票
- 能够使用历史数据回测策略
- 能够生成回测报告（收益率、夏普比率、最大回撤等）
- 初步验证策略有效性

**产出物**：
- 技术设计文档2份
- 代码模块：search/, backtest/
- 回测报告
- 策略优化建议

---

### 5.4 阶段三：观察池与监测（3-4周）

**目标**：实现双观察池管理和实时监测系统。

**主要任务**：

1. **第1周：技术设计文档编写**
   - 编写观察池系统技术设计文档
   - 编写监测系统技术设计文档
   - 评审技术设计文档

2. **第2周：观察池系统开发**
   - 实现RealtimePool
   - 实现DailyPool
   - 实现PoolManager
   - 实现PoolStorage
   - 单元测试

3. **第3周：监测系统开发**
   - 实现RealtimeStream（WebSocket实时行情）
   - 实现RealtimeMonitor
   - 实现SignalDetector
   - 实现AlertManager
   - 实现MonitorScheduler
   - 单元测试

4. **第4周：集成测试**
   - 搜索系统 → 观察池系统集成
   - 观察池系统 → 监测系统集成
   - 端到端测试（模拟实时监控）

**验收标准**：
- 能够将搜索结果加入观察池
- 能够实时监控观察池中的股票
- 能够检测买入信号并发送警报
- 能够实现池间转换逻辑

**产出物**：
- 技术设计文档2份
- 代码模块：observation/, monitoring/
- 集成测试报告

---

### 5.5 阶段四：交易执行与风险管理（3-4周）

**目标**：实现实盘交易和风险管理系统，**小资金测试**。

**主要任务**：

1. **第1周：技术设计文档编写**
   - 编写交易执行技术设计文档
   - 编写风险管理技术设计文档
   - 评审技术设计文档

2. **第2周：交易执行开发**
   - 实现TigerTradeAPI
   - 实现OrderManager
   - 实现PositionTracker
   - 实现ExecutionEngine
   - 单元测试（使用Tiger模拟账户）

3. **第3周：风险管理开发**
   - 实现StopLossManager
   - 实现TakeProfitManager
   - 实现PositionSizer
   - 实现RiskController
   - 单元测试

4. **第4周：小资金实盘测试**
   - 部署到测试环境
   - 使用小资金（如$1000-$5000）进行实盘测试
   - 监控系统运行状态
   - 记录交易日志
   - 分析实盘表现

**验收标准**：
- 能够通过Tiger API执行买卖操作
- 能够实时追踪持仓和订单状态
- 能够自动执行止盈止损
- 小资金实盘测试无重大bug

**产出物**：
- 技术设计文档2份
- 代码模块：trading/, risk/
- 实盘测试报告
- Bug修复和优化建议

---

### 5.6 阶段五：优化与部署（2-3周）

**目标**：参数优化、性能优化、生产部署。

**主要任务**：

1. **第1周：参数优化**
   - 实现ParameterOptimizer（基于Optuna）
   - 使用历史数据优化参数
   - 交叉验证
   - 确定最优参数组合

2. **第2周：性能优化和监控系统完善**
   - 代码性能优化（多进程、缓存）
   - 完善日志系统
   - 完善异常处理和恢复机制
   - 添加系统监控（资源占用、API调用频率等）

3. **第3周：生产部署**
   - 编写部署文档
   - 配置生产环境
   - 部署系统
   - 逐步增加资金规模
   - 持续监控和优化

**验收标准**：
- 参数优化完成，找到最优参数组合
- 系统性能满足实时监控要求
- 生产环境稳定运行
- 完整的部署和运维文档

**产出物**：
- 参数优化报告
- 性能优化报告
- 部署文档
- 运维手册

---

## 六、技术设计文档清单

基于模块化设计，需要编写以下技术设计文档（**阶段一开始前完成**）：

| 序号 | 文档名称 | 路径 | 内容概要 |
|------|---------|------|---------|
| 01 | 数据层设计 | `docs/modules/01_数据层设计.md` | Tiger API接口设计、数据缓存机制、实时数据订阅、数据验证逻辑 |
| 02 | 技术分析模块设计 | `docs/modules/02_技术分析模块设计.md` | 凸点识别算法（含伪代码）、突破检测算法、质量评分系统、技术指标计算 |
| 03 | 搜索系统设计 | `docs/modules/03_搜索系统设计.md` | 历史扫描算法、过滤器设计、搜索引擎架构、结果格式定义 |
| 04 | 观察池系统设计 | `docs/modules/04_观察池系统设计.md` | 双观察池数据结构、池间转换逻辑、持久化存储方案、循环跟踪机制 |
| 05 | 监测系统设计 | `docs/modules/05_监测系统设计.md` | 实时监控架构、买入信号检测逻辑、警报系统设计、调度器设计 |
| 06 | 交易执行设计 | `docs/modules/06_交易执行设计.md` | Tiger API交易接口、订单管理逻辑、持仓追踪、异常处理 |
| 07 | 风险管理设计 | `docs/modules/07_风险管理设计.md` | 止盈止损算法、仓位管理规则、风险控制逻辑、循环跟踪实现 |
| 08 | 回测系统设计 | `docs/modules/08_回测系统设计.md` | 回测引擎架构、性能指标计算、参数优化方案、报告生成 |
| 09 | 配置管理设计 | `docs/modules/09_配置管理设计.md` | 配置文件结构、参数验证规则、多环境配置方案 |
| 10 | 工具与辅助设计 | `docs/modules/10_工具与辅助设计.md` | 日志系统设计、数据库表设计、可视化工具设计、日期工具设计 |

**技术设计文档模板**：

每份技术设计文档应包含：
1. **模块概述**：职责、目标、依赖关系
2. **架构设计**：模块内部架构、子模块划分
3. **接口定义**：公共接口、输入输出格式
4. **核心算法**：算法流程、伪代码、复杂度分析
5. **数据结构**：核心数据结构定义
6. **异常处理**：异常场景、处理策略
7. **性能考虑**：性能瓶颈、优化方案
8. **测试方案**：单元测试、集成测试策略
9. **未决问题**：待讨论的技术选型或设计问题

---

## 七、风险与挑战

### 7.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| Tiger API限制或不稳定 | 数据获取失败、交易执行失败 | - 实现重试机制<br>- 设计降级方案<br>- 多数据源备份 |
| 凸点识别算法准确性不足 | 搜索结果质量差 | - 充分回测验证<br>- 参数优化<br>- 引入机器学习 |
| 实时监控性能瓶颈 | 无法及时检测买入信号 | - 使用WebSocket推送<br>- 多进程并行处理<br>- 优化算法复杂度 |
| 数据质量问题 | 错误的交易决策 | - 严格的数据验证<br>- 异常数据过滤<br>- 人工审核机制 |

### 7.2 策略风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 策略过度拟合 | 回测表现好，实盘表现差 | - 交叉验证<br>- 样本外测试<br>- 多时间段验证 |
| 市场环境变化 | 策略失效 | - 持续监控策略表现<br>- 定期重新优化参数<br>- 设计止损机制 |
| 滑点和手续费 | 实际收益低于预期 | - 回测中考虑滑点<br>- 使用限价单控制成本 |
| 流动性不足 | 无法成交或冲击成本高 | - 严格的流动性过滤<br>- 分批建仓 |

### 7.3 实施风险

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 开发时间超期 | 延迟上线 | - 迭代式开发<br>- MVP优先<br>- 灵活调整范围 |
| 资金安全 | 损失本金 | - 小资金测试<br>- 严格的风险控制<br>- 人工监督 |
| API权限和费用 | 成本增加或功能受限 | - 提前了解API限制<br>- 预算规划 |

---

## 八、成功标准

### 8.1 技术标准

- ✅ 所有模块单元测试通过率 > 90%
- ✅ 系统集成测试无重大bug
- ✅ 实时监控延迟 < 5秒
- ✅ 数据获取成功率 > 99%
- ✅ 交易执行成功率 > 95%

### 8.2 策略标准（回测）

- ✅ 年化收益率 > 15%
- ✅ 夏普比率 > 1.0
- ✅ 最大回撤 < 20%
- ✅ 胜率 > 50%
- ✅ 盈亏比 > 1.5

### 8.3 实盘标准（小资金测试）

- ✅ 系统稳定运行30天无重大故障
- ✅ 实盘收益与回测收益偏差 < 30%
- ✅ 无资金安全事故
- ✅ 所有交易有完整日志记录

---

## 九、下一步行动

### 9.1 立即行动（本周）

1. **评审本开发计划文档**
   - 确认模块划分是否合理
   - 确认开发阶段是否可行
   - 确认资源和时间安排

2. **申请Tiger API账号**
   - 注册Tiger Trade账号
   - 申请API权限（行情、交易）
   - 了解API限制和费用

3. **环境准备**
   - 安装Python 3.8+
   - 安装依赖库（pandas, numpy, tigeropen, backtrader, optuna等）
   - 配置开发环境

### 9.2 第一个里程碑（第1周结束）

1. **编写前3份技术设计文档**：
   - `docs/modules/01_数据层设计.md`
   - `docs/modules/02_技术分析模块设计.md`
   - `docs/modules/09_配置管理设计.md`
   - `docs/modules/10_工具与辅助设计.md`

2. **技术设计文档评审**
   - 确保接口定义清晰
   - 确保算法逻辑正确
   - 确保异常处理完善

3. **创建项目目录结构**
   ```bash
   mkdir -p BreakoutStrategy/{data,analysis,search,observation,monitoring,trading,risk,backtest,config,utils}
   mkdir -p docs/modules
   ```

### 9.3 后续里程碑

- **第2-3周**：数据层开发完成
- **第4-5周**：技术分析模块开发完成
- **第6周**：阶段一交付，进入阶段二
- **第10周**：阶段二交付，进入阶段三
- **第14周**：阶段三交付，进入阶段四
- **第18周**：阶段四交付（小资金实盘测试），进入阶段五
- **第21周**：项目完成，生产部署

---

## 十、附录

### 10.1 术语表

| 术语 | 英文 | 定义 |
|------|------|------|
| 凸点 | Peak | 股价高于两侧一定时段的高点，形成历史阻力位 |
| 突破点 | Breakout Point | 股价高于凸点最高价，确认突破 |
| 实时观察池 | Realtime Observation Pool | 监测当日突破的股票，使用分钟行情 |
| 日K观察池 | Daily Observation Pool | 监测突破后回落的股票，使用日K行情 |
| 质量评分 | Quality Score | 对凸点和突破点的历史意义进行量化评估 |
| 循环跟踪 | Cyclic Tracking | 止盈止损后重新加入观察池，捕捉多轮波动 |
| 移动止损 | Trailing Stop Loss | 根据最高价动态调整止损价位 |

### 10.2 参考资料

- Tiger Open API官方文档：https://quant.itigerup.com/openapi/zh/python/overview/introduction.html
- Backtrader官方文档：https://www.backtrader.com/docu/
- Optuna官方文档：https://optuna.readthedocs.io/
- 突破选股策略原始文档：`docs/breakout_strategy.md`

### 10.3 联系方式

- 项目负责人：[待填写]
- 技术负责人：[待填写]
- 策略设计师：[待填写]

---

**文档版本**：v1.0
**创建日期**：2025-11-16
**最后更新**：2025-11-16
**状态**：待评审
