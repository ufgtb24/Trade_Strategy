---
argument-hint: [scenario] [optional: natural language description]
description: 补充自动更新时遗漏的文档，支持智能推断
---

# 更新文档命令

你是一个文档管理专家，负责补充 BreakthroughStrategy 项目自动更新时遗漏的文档。

**使用场景**：补充 CLAUDE.md 第 63 行提到的自动更新遗漏

**场景类型**：$1
**补充描述**：$2（可选，支持自然语言）

**核心能力**：从上下文智能推断缺失信息（模块编号、版本号、文件路径等）

---

## 📚 文档系统结构

```
docs/
├── system/
│   ├── PRD.md              # 项目需求文档（静态）
│   └── current_state.md    # 开发状态索引（动态）
├── modules/
│   ├── plans/             # 模块设计文档（开发前）
│   └── README.md          # 模块文档说明
└── research/              # 研究报告（子代理输出）
```

## 🎯 场景处理逻辑

### 场景 1：`module` - 模块开发完成

**用途**：模块完成后，更新状态索引并验证代码文档完整性

**参数灵活性**：
```bash
# 完整自然语言描述
/update_doc module "数据层模块完成了，主要实现了 Tiger API 集成和缓存"

# 简化描述
/update_doc module "数据层完成"

# 只用场景类型（AI 自动推断所有信息）
/update_doc module
```

**AI 智能推断逻辑**：

1. **推断模块信息**
   - 如果 $2 未提供或不包含模块编号：
     - 运行 `git status` 查看新增/修改的代码文件
     - 从代码位置推断模块（如 `BreakthroughStrategy/data/` → 模块 01 数据层）
     - 对照 `current_state.md` 的待开发模块列表确认
   - 如果 $2 包含模块名称（如"数据层"）：
     - 从 `current_state.md` 查找对应编号

2. **验证代码文档完整性**
   - 检查模块目录下关键文件是否有 docstring
   - 提示：如有缺失，建议补充详细的类/函数注释
   - 参考编码规范（见 `PRD.md` 编码规范章节）

3. **更新 current_state.md**
   - 在"已完成"部分添加条目（包含完成日期和代码位置）
   - 从"待开发"部分移除
   - 更新计数（如 1/10 → 2/10）
   - 可选：添加核心特性简述（1-3条）

---

### 场景 2：`research` - 研究报告完成

**用途**：研究报告完成后，更新索引（验证报告文件存在）

**参数灵活性**：
```bash
# 指定文件路径和类别
/update_doc research "research/20251121_SMA_vs_EMA.md 算法研究"

# 简化描述（AI 推断类别）
/update_doc research "SMA vs EMA 对比分析"

# 只用场景类型（AI 查找最新报告）
/update_doc research
```

**AI 智能推断逻辑**：

1. **定位研究报告文件**
   - 如果 $2 包含文件路径：验证文件存在
   - 如果 $2 只包含报告名称：
     - 扫描 `docs/research/` 目录
     - 根据名称匹配查找文件
   - 如果 $2 未提供：
     - 列出 `docs/research/` 中所有 .md 文件
     - 选择最新创建的文件（按修改时间排序）

2. **推断报告类别**
   - 如果 $2 明确指定类别：直接使用
   - 如果未指定：
     - 从文件名关键词推断（如"算法"→ 算法研究）
     - 或从报告内容的第一段推断
     - 默认类别：技术调研

3. **验证并更新索引**
   - 检查报告文件是否存在
   - 如果不存在：提示用户并退出
   - 如果存在：
     - 从文件提取标题（第一行 # 标题）
     - 在 `current_state.md` 对应类别下添加链接
     - 如果该类别显示"暂无"，替换为报告条目

---

### 场景 3：`schedule` - 更新项目开发计划

**用途**：调整整个项目的开发优先级和计划

**参数灵活性**：
```bash
# 自然语言描述优先级调整
/update_doc schedule "优先开发搜索系统，延后回测系统"

# 简化描述
/update_doc schedule "先做搜索系统"

# 只用场景类型（AI 提示当前计划）
/update_doc schedule
```

**AI 智能推断逻辑**：

1. **读取当前计划**
   - 从 `current_state.md` 读取"下一步计划"
   - 读取"待开发"模块列表

2. **理解调整意图**
   - 如果 $2 提供描述：
     - 识别优先级关键词（如"优先"、"延后"、"先"、"后"）
     - 提取模块名称
     - 重新排序计划列表
   - 如果 $2 未提供：
     - 输出当前计划
     - 提示用户需要如何调整

3. **更新计划**
   - 更新 `current_state.md` 的"下一步计划"部分
   - 保持模块编号和依赖关系的正确性

---

### 场景 4：`plan` - 更新模块设计文档

**用途**：在开发过程中调整某模块的设计方案

**参数灵活性**：
```bash
# 指定模块编号和变更
/update_doc plan "03 增加多线程搜索支持"

# 自然语言描述
/update_doc plan "搜索系统需要增加多线程支持"

# 只用场景类型（AI 提示选择模块）
/update_doc plan
```

**AI 智能推断逻辑**：

1. **推断目标模块**
   - 如果 $2 包含编号（如"03"）：直接定位
   - 如果 $2 包含模块名称（如"搜索系统"）：
     - 从 `current_state.md` 查找对应编号
   - 如果 $2 只包含变更描述：
     - 扫描 `docs/modules/plans/` 目录
     - 根据描述关键词匹配模块名称
   - 如果 $2 未提供：
     - 列出所有待开发模块
     - 提示用户选择

   - 如果 $2 包含"新建"或类似词汇：
     **步骤 1：确认创建意图**
     - 从 $2 中提取模块信息（名称、编号）
     - 如果编号未提供，建议下一个可用编号（查看 `docs/modules/plans/` 现有文件）
     - 询问用户确认：模块名称、模块编号、优先级、主要依赖模块

     **步骤 2：创建设计文档**
     - 文件名：`XX_模块名设计.md`（XX 为两位数编号）
     - 保存位置：`docs/modules/plans/`
     - 创建设计文档（详见 [设计文档规范](../doc_write_standard.md)）

     **步骤 3：更新引用此设计文档的上层文档**
     - 更新 `docs/system/current_state.md`：
       - 在"待开发模块"表格中添加新模块条目（编号、模块名、状态、设计文档链接）
       - 更新模块计数（如 `9/10` → `10/11`）
       - 如果是高优先级，更新"下一步计划"
     - 更新 `docs/system/PRD.md`：
       - 在"### 2.1 模块总览"表格中添加新模块条目（层级、模块名、职责、链接）
       - 如需要，更新"### 2.2 模块依赖关系"

     **步骤 4：检查功能重叠**
     - 读取 `docs/system/PRD.md` 的"### 2.1 模块总览"
     - 对比新模块职责与现有模块职责
     - 如发现功能重叠：
       - 报告："新模块与以下模块可能存在功能重叠：[模块列表及重叠点]"
       - 建议："请确认：(1) 调整新模块职责 (2) 合并到现有模块 (3) 拆分现有模块"
       - 等待用户确认后再完成更新

     **步骤 5：验证并报告**
     - 确认设计文档包含足够实现指导
     - 确认 `current_state.md` 和 `PRD.md` 链接有效
     - 确认模块编号无重复
     - 报告：已创建文档路径、已更新文档列表、下一步建议
     - 任务完成


2. **理解变更内容**
   - 从 $2 提取关键变更（如"增加多线程支持"）
   - 读取对应的设计文档

3. **更新设计文档**
   - 定位需要修改的章节
   - 根据变更描述更新内容
   - 可选：在文档末尾添加变更记录

---

## ⚠️ 更新注意事项

**智能推断原则**：
- 优先从用户描述中提取信息
- 其次从项目上下文推断（git、文件系统、current_state.md）
- 推断不确定时，明确询问用户

**文档一致性**：
- 所有链接必须有效
- 日期格式统一使用 YYYY-MM-DD
- 模块编号保持一致

**module 场景特别注意**：
- ✅ 验证代码是否有详细的 docstring 和注释
- ✅ 提醒补充缺失的代码文档
- ✅ 从 git 和代码推断模块信息
- ❌ 不再创建总结文档（已废弃）

**research 场景特别注意**：
- ✅ 必须验证研究报告文件是否存在
- ❌ 不存在时不要创建空文档，应提示用户
- ✅ 自动从文件提取标题和推断类别

---

## 📞 使用示例

```bash
# === module 场景 ===

# 完整描述
/update_doc module "数据层模块完成，实现了 Tiger API 集成和缓存"

# 简化描述（AI 自动推断特性）
/update_doc module "数据层完成"

# 极简模式（AI 从 git 推断所有信息）
/update_doc module


# === research 场景 ===

# 指定路径和类别
/update_doc research "research/20251121_SMA_vs_EMA.md 算法研究"

# 只提供名称（AI 查找文件并推断类别）
/update_doc research "SMA vs EMA 对比分析"

# 极简模式（AI 使用最新的研究报告）
/update_doc research


# === schedule 场景 ===

# 自然语言描述
/update_doc schedule "优先开发搜索系统，延后回测系统"

# 简化描述
/update_doc schedule "先做搜索系统"

# 极简模式（AI 显示当前计划并询问调整）
/update_doc schedule


# === plan 场景 ===

# 指定编号
/update_doc plan "03 增加多线程搜索支持"

# 自然语言描述（AI 推断模块编号）
/update_doc plan "搜索系统需要增加多线程支持"

# 极简模式（AI 列出待开发模块供选择）
/update_doc plan
```

---

**命令版本**：v4.0（智能推断）
**创建日期**：2025-11-23
**核心能力**：从上下文智能推断缺失信息，支持自然语言输入
**核心职责**：补充自动更新时遗漏的文档，确保文档体系完整性
