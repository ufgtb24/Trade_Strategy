# 可视化模块设计文档

**模块编号**: 11
**优先级**: 中
**状态**: 设计完成，待开发
**依赖**: 技术分析模块（模块02）
**创建日期**: 2025-11-24

---

## 一、模块概述

### 1.1 核心目标

为整个 BreakthroughStrategy 项目提供通用的可视化能力，支持：
- 突破检测结果展示（K线图 + 峰值 + 突破标注）
- 参数调整与对比分析
- 回测结果可视化（未来）
- 实时监控面板（未来）

### 1.2 设计原则

- **通用性**: 作为独立的基础设施模块，与 analysis、backtest、search 等模块平级
- **可复用**: 提供通用组件（K线图、标记、面板），各业务模块可组合使用
- **渐进式**: 分阶段实现（静态图 → 交互式图 → 实时面板）
- **低耦合**: 不依赖具体业务逻辑，通过标准接口接收数据

---

## 二、架构设计

### 2.1 模块位置

```
BreakthroughStrategy/
├── analysis/          # 模块02：技术分析
├── visualization/     # 模块11：可视化（本模块，平级）
├── backtest/          # 模块08：回测系统（未来）
└── search/            # 模块03：搜索系统（未来）
```

**关键决策**: 可视化模块与 analysis 平级，而非作为子模块，原因：
1. 未来回测、搜索、实盘交易等模块都会需要可视化
2. 避免模块间循环依赖
3. 符合单一职责原则

### 2.2 目录结构

```
BreakthroughStrategy/visualization/
├── __init__.py
├── plotters/                      # 绘图器（按业务场景）
│   ├── __init__.py
│   ├── base_plotter.py           # 基类：通用绘图逻辑
│   ├── breakthrough_plotter.py   # 突破检测专用绘图器
│   ├── backtest_plotter.py       # 回测专用绘图器（未来）
│   └── portfolio_plotter.py      # 持仓专用绘图器（未来）
│
├── components/                    # 可复用组件
│   ├── __init__.py
│   ├── candlestick.py            # K线图组件
│   ├── markers.py                # 标记组件（峰值、突破点、交易信号）
│   ├── panels.py                 # 信息面板（统计、图例）
│   └── indicators.py             # 技术指标叠加（均线、布林带等）
│
├── interactive/                   # 交互式工具（可选）
│   ├── __init__.py
│   ├── parameter_explorer.py     # 参数调整界面
│   └── dashboard.py              # 实时监控面板
│
└── utils.py                      # 辅助函数（颜色映射、格式化等）
```

### 2.3 技术栈

**阶段一：静态图（优先）**
- `matplotlib 3.8.2`（已安装）
- `mplfinance`（需安装，轻量级金融图表库）

**阶段二：交互式图（可选）**
- `plotly`（需安装，交互式图表）
- `ipywidgets`（Jupyter Notebook 组件）或 `dash`（Web 应用）

---

## 三、核心功能设计

### 3.1 功能清单

| 功能 | 优先级 | 阶段 | 服务对象 |
|------|--------|------|----------|
| K线图 + 峰值 + 突破标注 | 高 | 阶段一 | 技术分析模块 |
| 突破详情图（局部放大） | 高 | 阶段一 | 技术分析模块 |
| 参数对比图（多子图） | 中 | 阶段一 | 参数调优 |
| 多峰值案例集 | 中 | 阶段一 | 案例分析 |
| 回测收益曲线 | 高 | 未来 | 回测系统 |
| 实时监控面板 | 中 | 未来 | 实盘交易 |
| 交互式参数调整 | 低 | 阶段二 | 参数调优 |

### 3.2 阶段一：核心静态可视化

#### 3.2.1 BreakthroughPlotter（突破检测绘图器）

**核心方法**:

```python
class BreakthroughPlotter(BasePlotter):
    """突破检测可视化工具"""

    def plot_full_analysis(self, df, breakthroughs, detector,
                          title=None, save_path=None):
        """
        绘制完整分析图

        参数:
            df: OHLCV DataFrame
            breakthroughs: List[Breakthrough] 突破列表
            detector: BreakthroughDetector 实例（获取 active_peaks）
            title: 图表标题
            save_path: 保存路径（可选）

        输出:
            - 上部：K线图 + 所有峰值标注 + 突破标注
            - 中部：成交量图（放量突破高亮）
            - 下部：统计信息面板
        """

    def plot_breakout_detail(self, df, breakthrough,
                            context_days=50, save_path=None):
        """
        绘制单个突破的详细视图

        参数:
            df: OHLCV DataFrame
            breakthrough: Breakthrough 对象
            context_days: 突破前后显示的天数
            save_path: 保存路径

        输出:
            - 局部K线图（突破前后N天）
            - 被突破峰值详细信息
            - 阻力区高亮
            - 质量评分分解
        """

    def plot_parameter_comparison(self, df, param_results,
                                 param_name, param_values):
        """
        绘制参数对比图

        参数:
            df: OHLCV DataFrame
            param_results: {param_value: (breakthroughs, detector)}
            param_name: 参数名称（如 'window'）
            param_values: 参数值列表（如 [3,5,7,10]）

        输出:
            - 多子图布局（每个参数值一张图）
            - 突破数量统计表
            - 质量分布对比
        """

    def plot_multi_peak_cases(self, df, multi_peak_breakthroughs,
                             top_n=5):
        """
        绘制多峰值突破案例集

        参数:
            df: OHLCV DataFrame
            multi_peak_breakthroughs: List[Breakthrough] 多峰值突破列表
            top_n: 显示前N个案例

        输出:
            - 网格布局（2x3）
            - 每个案例的局部图
            - 密集度和质量信息
        """
```

#### 3.2.2 核心组件

**CandlestickComponent（K线图组件）**

```python
class CandlestickComponent:
    """K线图绘制组件"""

    def draw(self, ax, df, style='charles'):
        """
        在指定 Axes 上绘制 K线图

        参数:
            ax: matplotlib Axes 对象
            df: OHLCV DataFrame
            style: K线样式（'charles', 'yahoo', 'binance'）
        """
```

**MarkerComponent（标记组件）**

```python
class MarkerComponent:
    """标记绘制组件（峰值、突破点、交易信号）"""

    def draw_peaks(self, ax, peaks, quality_color_map=True):
        """
        绘制峰值标记

        参数:
            ax: matplotlib Axes 对象
            peaks: List[Peak] 峰值列表
            quality_color_map: 是否根据质量分数映射颜色
        """

    def draw_breakthroughs(self, ax, breakthroughs,
                          highlight_multi_peak=True):
        """
        绘制突破标记

        参数:
            ax: matplotlib Axes 对象
            breakthroughs: List[Breakthrough] 突破列表
            highlight_multi_peak: 多峰值突破是否使用大标记
        """

    def draw_resistance_zones(self, ax, breakthroughs, df):
        """
        绘制阻力区高亮（半透明矩形）

        参数:
            ax: matplotlib Axes 对象
            breakthroughs: List[Breakthrough] 突破列表
            df: OHLCV DataFrame（用于计算 x 坐标）
        """
```

**PanelComponent（信息面板组件）**

```python
class PanelComponent:
    """信息面板组件"""

    def draw_statistics_panel(self, ax, breakthroughs):
        """
        绘制统计信息面板

        参数:
            ax: matplotlib Axes 对象
            breakthroughs: List[Breakthrough] 突破列表

        显示内容:
            - 总突破数
            - 多峰值突破数
            - 平均质量分数
            - Top5 平均分
        """
```

### 3.3 可视化元素规范

#### 3.3.1 颜色编码

**峰值质量颜色**:
- 红色（`#D32F2F`）: 质量 ≥ 60 分（高质量）
- 橙色（`#F57C00`）: 40 ≤ 质量 < 60 分（中等质量）
- 灰色（`#9E9E9E`）: 质量 < 40 分（低质量）

**突破质量颜色**: 同峰值质量颜色

**阻力区颜色**:
- 黄色半透明（`#FFEB3B`, alpha=0.2）: 密集阻力区

#### 3.3.2 标记样式

**峰值标记**:
- 活跃峰值: 向上三角形 `^`，尺寸 10pt
- 已突破峰值: 向下三角形 `v`，尺寸 8pt，灰色

**突破标记**:
- 单峰值突破: 星形 `*`，尺寸 10pt
- 多峰值突破: 星形 `*`，尺寸 15pt

#### 3.3.3 图表布局

**全局分析图**:
```
┌─────────────────────────────────────┐
│ 标题                                 │
├─────────────────────────────────────┤
│                                     │
│  K线图 + 峰值 + 突破标注             │
│  (height_ratio = 3)                 │
│                                     │
├─────────────────────────────────────┤
│  成交量图                            │
│  (height_ratio = 1)                 │
├─────────────────────────────────────┤
│  统计信息面板                        │
│  (height_ratio = 0.3)               │
└─────────────────────────────────────┘
```

---

## 四、使用场景与工作流

### 4.1 场景1：快速参数对比（静态图）

**目标**: 对比不同 window 值的效果

**脚本**: `scripts/parameter_tuning.py`

**工作流**:
```
1. 配置参数范围：window=[3,5,7,10]
2. 运行脚本，自动生成对比图
3. 输出统计CSV和PNG图片
4. 分析结果，选择最优参数
```

### 4.2 场景2：Top突破可视化

**目标**: 展示质量评分最高的5个突破

**脚本**: `scripts/visual_demo.py`

### 4.3 场景3：多峰值案例深度分析

**目标**: 分析一次突破多个峰值的案例

**脚本**: `scripts/case_analysis.py`

---

## 五、实施计划

### 5.1 阶段一：核心静态可视化（1-2天）

**优先级**: 高

**任务清单**:
1. 安装 `mplfinance`
2. 创建目录结构（`visualization/`, `scripts/`）
3. 实现核心组件：
   - `CandlestickComponent`
   - `MarkerComponent`
   - `PanelComponent`
4. 实现 `BreakthroughPlotter` 类：
   - `plot_full_analysis()`
   - `plot_breakout_detail()`
5. 创建演示脚本：
   - `scripts/visual_demo.py`

**交付物**:
- 基础可视化功能可用
- 示例PNG输出
- 演示脚本可运行

### 5.2 阶段二：参数调整工具（1天）

**优先级**: 中

**任务清单**:
1. 实现 `plot_parameter_comparison()`
2. 实现 `plot_multi_peak_cases()`
3. 创建工具脚本：
   - `scripts/parameter_tuning.py`
   - `scripts/case_analysis.py`

### 5.3 阶段三：交互式探索（2-3天，可选）

**优先级**: 低

**任务清单**:
1. 安装 `plotly`
2. 实现 `InteractiveBreakthroughExplorer` 类
3. 创建 Jupyter Notebook 演示

---

## 六、依赖与环境

### 6.1 依赖安装

**最小依赖（阶段一）**:
```bash
pip install mplfinance
```

**完整依赖（阶段三）**:
```bash
pip install mplfinance plotly ipywidgets
```

### 6.2 环境要求

- Python: 3.8+
- matplotlib: 3.8.2（已安装）
- 操作系统: Linux/macOS/Windows（跨平台）

---

## 七、风险与注意事项

### 7.1 性能风险

**问题**: 1255天K线 + 59个突破，图表可能拥挤

**解决方案**:
1. 提供时间范围过滤（`start_date`, `end_date` 参数）
2. 支持局部绘图（`plot_breakout_detail` 只绘制前后50天）

### 7.2 数据格式兼容性

**问题**: mplfinance 对 DataFrame 格式有要求（必须是 DatetimeIndex）

**解决方案**:
1. 在 `BasePlotter` 中统一处理数据格式转换
2. 提供格式检查和自动修复工具

---

## 八、总结

### 8.1 核心价值

1. **通用性**: 作为独立模块，服务全项目的可视化需求
2. **可复用**: 组件化设计，业务模块可灵活组合
3. **渐进式**: 分阶段实现，优先满足核心需求

### 8.2 关键决策

1. ✅ 模块位置: 与 analysis 平级（而非子模块）
2. ✅ 技术栈: 优先静态图（matplotlib + mplfinance）
3. ✅ 实施策略: 分3个阶段（核心 → 工具 → 交互式）

### 8.3 下一步行动

1. 安装 `mplfinance`
2. 创建模块结构
3. 实现核心绘图类
4. 创建演示脚本

---

**文档版本**: v1.0
**创建日期**: 2025-11-24
**作者**: Claude Code
**状态**: 设计完成，待开发
