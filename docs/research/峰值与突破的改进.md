# 峰值检测与突破确认的改进研究

> 研究日期：2025-12-23
> 研究背景：当前系统使用 `high` 定义峰值和确认突破，在高波动市场下容易产生假峰值（如长上影线）

---

## 一、问题背景

### 1.1 当前实现

```python
# breakout_detector.py
# 峰值检测：使用 high
window_highs = self.highs[window_start:current_idx]
max_high = max(window_highs)

# 突破确认：使用 high
if current_high > peak.price * (1 + exceed_threshold):
    # 触发突破
```

### 1.2 存在的问题

| 问题 | 表现 | 影响 |
|-----|------|-----|
| 长上影线假峰值 | Peak 6、7 类型被错误识别 | 峰值噪音多 |
| 高波动市场 | `high - low` 差距大，条件3易满足 | 假阳性率高 |
| 日内冲高回落 | high 触发突破但 close 回落 | 假突破陷阱 |

---

## 二、峰值定义方案研究

### 2.1 三种价格定义对比

| 方案 | 定义 | 抗噪性 | 信息完整性 | 抗操纵性 |
|-----|------|-------|-----------|---------|
| **High** | K线最高价 | 2/5 | 5/5 | 2/5 |
| **Close** | K线收盘价 | 5/5 | 3/5 | 5/5 |
| **Body Top** | `max(open, close)` | 4/5 | 4/5 | 4/5 |

### 2.2 理论依据

#### 日本蜡烛图理论
- **实体（body）**：多空博弈的最终结果，"被接受的价格"
- **影线（shadow）**：试探性动作，"被拒绝的价格"

> Steve Nison: "The shadows are usually considered as extraneous price fluctuations."

#### Wyckoff 理论
- 长上影线被明确归类为 **Upthrust（假突破）**
- 供需区边界是实体边界，不是影线极值

#### 市场微观结构
- 实体区域集中 60-80% 成交量
- 影线区域套牢盘少，阻力意义弱

### 2.3 推荐方案：Body Top

```python
def get_peak_price(open_price: float, high: float, close: float) -> float:
    """
    峰值价格：使用实体上界

    优势：
    1. 阳线时 body_top = close（多方控盘价位）
    2. 阴线时 body_top = open（空方进入前最高价）
    3. 过滤长上影线噪音
    """
    return max(open_price, close)
```

---

## 三、突破确认价格研究

### 3.1 四种组合方案对比

| 组合 | 逻辑一致性 | 假突破风险 | 专业认可 | 综合评分 |
|-----|-----------|-----------|---------|---------|
| 峰值body_top + 突破high | 6/10 | 高 | 6/10 | **7.0/10** |
| 峰值body_top + 突破close | 7/10 | 低 | 9/10 | **7.75/10** |
| 峰值body_top + 突破body_top | 9/10 | 中 | 7/10 | **7.5/10** |
| 双重确认（body_top+close验证） | 8/10 | 最低 | 8/10 | **8.5/10** ✅ |

### 3.2 关键场景分析

#### 场景A：标准阳线突破（所有方案均有效）
```
峰值日：body_top = 100
突破日：open=99, high=103, close=102
→ 所有方案均正确识别突破
```

#### 场景B：跳空高开阴线（核心问题）
```
峰值日：body_top = 100
突破日：open=103, high=105, close=98（跳空高开后大跌）

方案1 (body_top+high)：high=105 > 100 → 触发 ⚠️ 假突破
方案2 (body_top+close)：close=98 < 100 → 不触发 ✅ 正确
方案3 (body_top+body_top)：body_top=103 > 100 → 触发 ⚠️ 陷阱
方案4 (双重确认)：body_top=103✓ 但 close=98✗ → 不确认 ✅ 正确
```

**关键洞察**：阴线的 `body_top = open`，跳空高开后回落仍会被识别为"突破"。

#### 场景C：长上影线突破（body_top 优势体现）
```
峰值日：body_top = 100
突破日：open=99, high=110, close=101

用 high 确认：110 > 100（10% 突破）→ 高估强度
用 body_top 确认：101 > 100（1% 突破）→ 正确识别为弱突破
```

### 3.3 专业交易者共识

> "A breakout requires the **close of a candle**... Waiting for the candle to close can help you avoid being whipsawed."

> "For a proper breakout, the **body of the breakout candle** must cross the resistance level and **close outside** of this level."

> "2-candle close confirmation can filter 70% of traps."（2024年实证数据）

---

## 四、推荐实施方案

### 4.1 方案概览

| 方案 | 峰值定义 | 突破确认 | 适用场景 |
|-----|---------|---------|---------|
| **A: 简单切换** | body_top | body_top | 快速试验 |
| **B: 双重确认** | body_top | body_top + close验证 | 生产推荐 |
| **C: 参数化** | 可配置 | 可配置 | 灵活适配 |

### 4.2 推荐方案B：双重确认机制

```python
def check_breakout(current_bar, peak, config):
    """
    双重确认：body_top触发 + close验证

    Args:
        current_bar: 当前K线数据
        peak: 峰值对象
        config: 配置参数

    Returns:
        'STRONG': 强突破（body_top和close都确认）
        'WEAK': 弱突破（仅body_top确认）
        None: 无突破
    """
    body_top = max(current_bar['open'], current_bar['close'])
    peak_body_top = peak.price

    exceed_threshold = config.get('exceed_threshold', 0.005)  # 0.5%
    close_tolerance = config.get('close_tolerance', 0.02)     # 2%

    # 条件1：实体上界突破（敏感检测）
    body_breakout = body_top > peak_body_top * (1 + exceed_threshold)

    # 条件2：收盘价验证（安全确认）
    close_confirm = current_bar['close'] > peak_body_top * (1 - close_tolerance)

    # 双重确认
    if body_breakout and close_confirm:
        return "STRONG"
    elif body_breakout and not close_confirm:
        return "WEAK"
    else:
        return None
```

### 4.3 参数调整建议

| 参数 | High方案（当前） | Body Top方案 | 说明 |
|-----|----------------|-------------|-----|
| `min_strict_height` | 0.15 | 0.10-0.12 | body_top < high，需降低 |
| `min_relative_height` | 0.05 | 0.03-0.04 | 同上 |
| `exceed_threshold` | 0.005 | 0.005-0.008 | 突破检测阈值 |
| `close_tolerance` | - | 0.02 | **新增**：收盘价回落容忍度 |

---

## 五、条件3、4、5的保留建议

### 5.1 当前条件回顾

| 条件 | 公式 | 默认阈值 | 作用 |
|-----|------|---------|-----|
| 条件3 | `(peak_high - window_min_low) / window_min_low` | 0.05 | 相对高度 |
| 条件4 | `(peak_high - max_neighbor_high) / max_neighbor_high` | 0.03 | 局部突出度 |
| 条件5 | `(peak_high - window_min_high) / window_min_high` | 0.15 | 严格高度 |

### 5.2 改用 Body Top 后的调整

| 条件 | 是否保留 | 调整建议 |
|-----|---------|---------|
| **条件3** | ✅ 必须保留 | 过滤平坦区假峰值，阈值降至 3-4% |
| **条件4** | ⚠️ 可选保留 | body_top 已部分替代，阈值降至 1-2% 或禁用 |
| **条件5** | ⚠️ 可大幅简化 | 专门针对长影线，body_top 已在源头解决，阈值降至 5-8% 或禁用 |

### 5.3 简化后的条件

```python
# 改用 body_top 后的推荐配置
config = {
    'min_relative_height': 0.03,     # 条件3：保留
    'min_local_prominence': 0.0,     # 条件4：禁用（设为0）
    'min_strict_height': 0.05,       # 条件5：大幅降低
}
```

---

## 六、场景化决策指南

### 6.1 市场环境决策树

```
[当前市场环境？]
│
├─ 趋势市（ADX > 25）
│   └─ 峰值：body_top
│      突破：body_top（保持一致性）
│      额外：添加收盘价安全阈值
│
├─ 震荡市（ADX < 20）
│   └─ 峰值：body_top
│      突破：close（最保守）
│      理由：过滤假突破优先
│
└─ 不确定
    └─ 峰值：body_top
       突破：双重确认（body_top + close验证）
       理由：兼顾敏感性和可靠性
```

### 6.2 时间框架影响

| 时间框架 | 推荐峰值 | 推荐突破确认 | 理由 |
|---------|---------|------------|-----|
| 日线 | body_top | close 或 双重确认 | 过滤日内噪声 |
| 周线 | body_top | close | 更稳健 |
| 分钟级 | high 或 body_top | 多时间框架确认 | 需要更高层级验证 |

---

## 七、代码实施指南

### 7.1 修改文件清单

| 文件 | 修改内容 | 优先级 |
|-----|---------|-------|
| `breakout_detector.py` | 添加 `peak_measure` 参数，修改条件5 | 高 |
| `breakout_detector.py` | 添加 `close_tolerance` 参数到突破检测 | 高 |
| `configs/analysis/params/` | 添加不同场景配置文件 | 中 |
| `peak_scorer.py` | 调整 `height_bonus_thresholds` | 低 |

### 7.2 核心代码修改

#### 步骤1：添加参数

```python
def __init__(self,
             ...
             peak_measure: str = 'high',           # 'high', 'close', 'body_top'
             breakout_measure: str = 'high',   # 'high', 'close', 'body_top'
             close_tolerance: float = 0.02,        # 收盘价回落容忍度
             ...):
    self.peak_measure = peak_measure
    self.breakout_measure = breakout_measure
    self.close_tolerance = close_tolerance
```

#### 步骤2：修改峰值检测

```python
def _get_measure_price(self, idx: int, measure: str) -> float:
    """获取指定度量的价格"""
    if measure == 'high':
        return self.highs[idx]
    elif measure == 'close':
        return self.prices[idx]
    elif measure == 'body_top':
        return max(self.opens[idx], self.prices[idx])
    else:
        raise ValueError(f"Unknown measure: {measure}")

def _detect_peak_in_window(self, current_idx: int):
    # ...
    # 使用 self.peak_measure 替代硬编码的 high
    peak_price = self._get_measure_price(peak_global_idx, self.peak_measure)
```

#### 步骤3：修改突破确认

```python
def _check_breakouts(self, current_idx, current_high, current_date):
    current_close = self.prices[current_idx]
    current_open = self.opens[current_idx]

    # 获取突破确认价格
    if self.breakout_measure == 'high':
        breakout_price = current_high
    elif self.breakout_measure == 'close':
        breakout_price = current_close
    elif self.breakout_measure == 'body_top':
        breakout_price = max(current_open, current_close)

    for peak in self.active_peaks:
        exceed_threshold_price = peak.price * (1 + self.exceed_threshold)

        if breakout_price > exceed_threshold_price:
            # 双重确认：检查收盘价安全阈值
            close_safe = current_close > peak.price * (1 - self.close_tolerance)

            if close_safe:
                breakout_type = "STRONG"
            else:
                breakout_type = "WEAK"

            # ... 记录突破
```

### 7.3 配置文件示例

```yaml
# configs/analysis/params/peak_body_top.yaml
breakout_detector:
  peak_measure: 'body_top'
  breakout_measure: 'body_top'
  close_tolerance: 0.02
  min_relative_height: 0.03
  min_local_prominence: 0.0
  min_strict_height: 0.05
  exceed_threshold: 0.005
```

---

## 八、回测验证计划

### 8.1 对比实验设计

```python
configs = [
    {'name': 'Baseline (High+High)',
     'peak_measure': 'high', 'breakout_measure': 'high'},

    {'name': 'Body Top + Body Top',
     'peak_measure': 'body_top', 'breakout_measure': 'body_top'},

    {'name': 'Body Top + Close',
     'peak_measure': 'body_top', 'breakout_measure': 'close'},

    {'name': 'Body Top + Dual Confirm',
     'peak_measure': 'body_top', 'breakout_measure': 'body_top',
     'close_tolerance': 0.02},
]
```

### 8.2 评估指标

| 指标 | 计算方式 | 期望变化 |
|-----|---------|---------|
| 峰值数量 | `len(active_peaks)` | 减少 15-25% |
| 突破数量 | `len(breakouts)` | 减少 10-20% |
| 假突破率 | 5天内回落>3%的比例 | 降低 20-30% |
| 平均收益 | 突破后5/10天收益 | 提升 |
| 夏普比率 | 风险调整后收益 | 提升 |

### 8.3 测试数据集

| 数据集 | 时间范围 | 市场状态 |
|-------|---------|---------|
| 牛市样本 | 2023-01 ~ 2023-06 | 趋势上涨 |
| 熊市样本 | 2022-01 ~ 2022-06 | 趋势下跌 |
| 震荡样本 | 2024-01 ~ 2024-06 | 横盘整理 |

---

## 九、风险与注意事项

### 9.1 主要风险

| 风险 | 描述 | 缓解措施 |
|-----|------|---------|
| 跳空高开阴线 | body_top=open 可能误判 | 添加 close_tolerance 验证 |
| 参数不一致 | 多处参数需协调调整 | 使用配置文件统一管理 |
| 缓存兼容性 | 新旧参数缓存冲突 | 在缓存键中包含 measure 类型 |
| 信号减少 | 更严格的过滤导致信号变少 | 接受更高质量的少量信号 |

### 9.2 降级计划

1. 保留 `peak_measure='high'` 作为默认值
2. 新模式作为可选配置
3. 如果回测表现不佳，直接恢复配置
4. 缓存系统自动区分不同 measure 的结果

---

## 十、总结

### 10.1 核心改进

1. **峰值定义**：从 `high` 改为 `body_top = max(open, close)`
   - 过滤长上影线噪音
   - 更符合技术分析理论

2. **突破确认**：推荐双重确认机制
   - body_top 触发 + close 验证
   - 兼顾敏感性和可靠性

3. **条件简化**：条件4、5 可大幅简化或禁用
   - body_top 已在源头解决长影线问题

### 10.2 预期效果

| 指标 | 预期变化 |
|-----|---------|
| 假峰值率 | 降低 20-30% |
| 假突破率 | 降低 20-30% |
| 信号质量 | 显著提升 |
| 参数稳定性 | 提升 |

### 10.3 实施优先级

| 阶段 | 任务 | 时间 |
|-----|------|-----|
| Phase 1 | 添加 `peak_measure` 参数，实现 body_top | 1-2天 |
| Phase 2 | 添加 `close_tolerance` 双重确认 | 1天 |
| Phase 3 | 回测对比验证 | 1-2周 |
| Phase 4 | 根据结果调整默认配置 | 1天 |

---

## 参考资源

### 学术文献
- [Foundations of Technical Analysis - Andrew Lo et al.](https://www.cis.upenn.edu/~mkearns/teaching/cis700/lo.pdf)
- [Memory effects in stock price dynamics - Nature Scientific Reports](https://www.nature.com/articles/srep04487)

### 专业交易资源
- [Wyckoff Method - Wyckoff Analytics](https://www.wyckoffanalytics.com/wyckoff-method/)
- [Japanese Candlestick Charting Techniques - Steve Nison](https://archive.org/details/JapaneseCandlestickChartingTechniques2ndEditionSteveNison)
- [Breakout Trading Strategies - Mind Math Money](https://www.mindmathmoney.com/articles/breakout-trading-strategies-that-actually-work-in-2025)

### 量化平台
- [QuantConnect Donchian Channel Breakout](https://www.quantconnect.com/forum/discussion/14220/donchian-channel-breakout-strategy/)
- [TradingView Breakout Indicator](https://www.tradingview.com/script/L80FlxDA-Breakout-Indicator/)
